/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var Br=Object.defineProperty;var Zo=Object.getOwnPropertyDescriptor;var Qn=Object.getOwnPropertyNames;var Vn=Object.prototype.hasOwnProperty;var An=(o,e)=>{for(var t in e)Br(o,t,{get:e[t],enumerable:!0})},Ln=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Qn(e))!Vn.call(o,i)&&i!==t&&Br(o,i,{get:()=>e[i],enumerable:!(r=Zo(e,i))||r.enumerable});return o};var Mn=o=>Ln(Br({},"__esModule",{value:!0}),o),u=(o,e,t,r)=>{for(var i=r>1?void 0:r?Zo(e,t):e,n=o.length-1,s;n>=0;n--)(s=o[n])&&(i=(r?s(e,t,i):s(i))||i);return r&&i&&Br(e,t,i),i};var Ya={};An(Ya,{default:()=>ao});module.exports=Mn(Ya);var Xr=require("obsidian");function lo(){let e=[{id:"up",visualDirection:"ascending"},{id:"down",visualDirection:"descending"},{id:"next",visualDirection:"sequential"},{id:"prev",visualDirection:"sequential"}].map(({id:r,visualDirection:i})=>({id:r,aliases:uo(r),impliedRelations:[],visualDirection:i})),t=[["up","down"],["down","up"],["next","prev"],["prev","next"]];for(let[r,i]of t){let n=e.find(s=>s.id===r);n&&n.impliedRelations.push({targetRelation:i,direction:"reverse"})}return e}function po(){return[{query:`group "Ancestors"
from up`,enabled:!0},{query:`group "Children"
from down`,enabled:!0},{query:`group "Siblings"
from next depth 1, prev depth 1`,enabled:!0}]}function uo(o){return[{key:o},{key:`relations.${o}`}]}function qr(o){return{query:In(o),enabled:!0}}function ei(o){return o.map(qr)}function In(o){var r,i,n,s;let e=[];e.push(`group "${$r(o.name||"Unnamed")}"`);let t=o.members.map(a=>{let l=a.relation;return a.depth>0&&(l+=` depth ${a.depth}`),a.extend&&(l+=` extend ${a.extend}`),l});if(t.length>0?e.push(`from ${t.join(", ")}`):e.push("from up depth 1"),o.filters&&o.filters.length>0){let a=Jo(o.filters,(r=o.filtersMatchMode)!=null?r:"all");a&&e.push(`where ${a}`)}if(o.showConditions&&o.showConditions.length>0){let a=Jo(o.showConditions,(i=o.showConditionsMatchMode)!=null?i:"all");a&&e.push(`when ${a}`)}if(o.sortBy&&o.sortBy.length>0||o.chainSort){let a=Bn((n=o.sortBy)!=null?n:[],(s=o.chainSort)!=null?s:"disabled");a&&e.push(`sort ${a}`)}if(o.displayProperties&&o.displayProperties.length>0){let a=o.displayProperties.join(", ");e.push(`display ${a}`)}return e.join(`
`)}function Jo(o,e){var i;let t=o.map(Xn).filter(n=>n!==null);if(t.length===0)return null;if(t.length===1)return(i=t[0])!=null?i:null;let r=e==="all"?" and ":" or ";return t.join(r)}function Xn(o){let e=ti(o.key);switch(o.operator){case"equals":return o.value===void 0||o.value===null?`${e} = null`:typeof o.value=="string"?`${e} = "${$r(o.value)}"`:typeof o.value=="boolean"?`${e} = ${o.value}`:`${e} = ${o.value}`;case"contains":return typeof o.value=="string"?`contains(${e}, "${$r(o.value)}")`:null;case"exists":return`exists(${e})`;case"notExists":return`not exists(${e})`;default:return null}}function Bn(o,e){let t=[];e==="primary"&&t.push("$chain");for(let r of o){let i=ti(r.property);r.direction==="desc"?t.push(`${i} desc`):t.push(i)}return e==="secondary"&&t.length>0&&t.push("$chain"),t.length>0?t.join(", "):null}function ti(o){return`$file.properties.${o.split(".").map(r=>$n(r)?r:`"${$r(r)}"`).join(".")}`}function $n(o){return!(new Set(["group","from","depth","unlimited","extend","prune","where","when","sort","asc","desc","display","all","and","or","not","in","true","false","null","today","yesterday","tomorrow","startOfWeek","endOfWeek"]).has(o)||!/^[\p{L}\p{So}\p{Sc}_][\p{L}\p{N}\p{So}\p{Sc}_-]*$/u.test(o))}function $r(o){return o.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\t/g,"\\t")}function qn(o){let e=o;return e=e.replace(/\s+depth\s+unlimited\b/gi,""),e=e.replace(/(?<!:)\bdepth\s+(\d+)/gi,":depth $1"),e=e.replace(/(?<!:)\bflatten\b/gi,":flatten"),e=e.replace(/\bsort\s+by\b/gi,"sort"),e=Gn(e),e=e.replace(/(?<!\$)\bfile\.(name|path|folder|ext|modified|created|size|tags|aliases)\b/g,"\\$file.$1"),e=e.replace(/(?<!\$)\btraversal\.(depth|relation)\b/g,"\\$traversal.$1"),e=e.replace(/\bgroup\s*\(\s*"([^"\\]*(?:\\.[^"\\]*)*)"\s*\)/g,'@"$1"'),e=e.replace(/  +/g," "),e=e.replace(/ +$/gm,""),e=e.replace(/\\(\$)/g,"$1"),e}function Gn(o){let e=/\bsort\s+([\s\S]*?)(?=\b(?:display|where|when|prune|group|from)\b|$)/gi;return o.replace(e,(t,r)=>{let i=r;return i=i.replace(/(?<!:)\bchain\b/g,":chain"),i=i.replace(/(?<!:)\basc\b/gi,":asc"),i=i.replace(/(?<!:)\bdesc\b/gi,":desc"),`sort ${i}`})}function co(o){return[/(?<!:)\bdepth\s+\d+/i,/\bdepth\s+unlimited\b/i,/(?<!:)\bflatten\b/i,/\bsort\s+by\b/i,/\bsort\s+[^:]*(?<!:)\b(asc|desc)\b/i,/\bsort\s+[^:]*(?<!:)\bchain\b/i,/(?<!\$)\bfile\.(name|path|folder|ext|modified|created|size|tags|aliases)\b/,/(?<!\$)\btraversal\.(depth|relation)\b/,/\bgroup\s*\(\s*"[^"]*"\s*\)/].some(t=>t.test(o))}function ri(o){let e=0;for(let t of o)co(t.query)&&(t.query=qn(t.query),e++);return{migrated:e>0,count:e}}var cn=require("obsidian");var O=require("obsidian");var Fn=/^[a-z0-9_-]+$/i;function mo(o){return o.trim()}function fo(o){return o.length===0?!1:Fn.test(o)}var ii=require("obsidian"),oi="text/trail-reorder-index";function vr(o,e,t,r,i){let n=o.createDiv({cls:"trail-drag-handle",attr:{"aria-label":"Drag to reorder"}});(0,ii.setIcon)(n,"grip-vertical"),e.draggable=!0,e.dataset.reorderIndex=String(t);let s=!1;n.addEventListener("mousedown",()=>{s=!0}),n.addEventListener("mouseup",()=>{s=!1}),e.addEventListener("dragstart",a=>{if(!s){a.preventDefault();return}a.stopPropagation(),e.dataset.dragging="true",a.dataTransfer&&(a.dataTransfer.effectAllowed="move",a.dataTransfer.setData(oi,String(t)))}),e.addEventListener("dragend",a=>{a.stopPropagation(),delete e.dataset.dragging,s=!1,document.querySelectorAll(".trail-drag-over").forEach(l=>{l.classList.remove("trail-drag-over")})}),e.addEventListener("dragover",a=>{a.preventDefault(),a.stopPropagation(),a.dataTransfer&&(a.dataTransfer.dropEffect="move"),e.classList.add("trail-drag-over")}),e.addEventListener("dragleave",a=>{a.stopPropagation(),e.classList.remove("trail-drag-over")}),e.addEventListener("drop",a=>{var f;a.preventDefault(),a.stopPropagation(),e.classList.remove("trail-drag-over");let l=(f=a.dataTransfer)==null?void 0:f.getData(oi);if(l===void 0||l==="")return;let c=parseInt(l,10),m=t;if(c===m||isNaN(c))return;let[d]=r.splice(c,1);d!==void 0&&(r.splice(m,0,d),i())})}var Wn=require("obsidian");var _n=require("obsidian");function Nr(o,e){let t=o.createEl("details",{cls:e}),r=t.createEl("summary",{cls:"trail-relation-summary"}),i=r.createDiv({cls:"trail-relation-summary-content"}),n=t.createDiv({cls:"trail-relation-content"});return{details:t,summary:r,summaryContent:i,content:n}}var Ht=require("obsidian"),Cr=class extends Ht.AbstractInputSuggest{constructor(e,t,r){super(e,t),this.textInputEl=t,this.onSelectCallback=r}getSuggestions(e){let t=(0,Ht.getIconIds)(),r=e.toLowerCase().trim();return r?t.filter(i=>{let n=i.toLowerCase(),s=n.replace(/^lucide-/,"");return n.includes(r)||s.includes(r)}).slice(0,50):t.slice(0,50)}renderSuggestion(e,t){t.addClass("trail-icon-suggestion");let r=t.createSpan({cls:"trail-icon-suggestion-icon"});(0,Ht.setIcon)(r,e);let i=e.replace(/^lucide-/,"");t.createSpan({cls:"trail-icon-suggestion-text",text:i})}selectSuggestion(e,t){this.textInputEl.value=e,this.textInputEl.dispatchEvent(new Event("input")),this.onSelectCallback(e),this.close()}};var wr=class{constructor(e,t){this.plugin=e,this.display=t}saveOpenState(e){let t=e.querySelectorAll(".trail-relation-section"),r=new Set;return t.forEach((i,n)=>{i.open&&r.add(n)}),r}render(e,t){new O.SettingGroup(e).setHeading("Relations").addSetting(r=>{r.setDesc("Define relation types and their aliases.")});for(let[r,i]of this.plugin.settings.relations.entries())this.renderRelationSection(e,i,r,t);this.renderAddRelationControl(e,t)}renderRelationSection(e,t,r,i){let{details:n,summary:s,summaryContent:a,content:l}=Nr(e,"trail-relation-section"),c=i.has(r),m=!t.id;n.open=c||m;let d=De(t),f=a.createEl("span",{cls:"trail-relation-name",text:d||"(unnamed)"});t.id||f.addClass("trail-relation-name-empty");let g=a.createDiv({cls:"trail-relation-badges"});g.createEl("span",{cls:"trail-badge",text:`${t.aliases.length} alias${t.aliases.length!==1?"es":""}`}),g.createEl("span",{cls:"trail-badge",text:`${t.impliedRelations.length} implied`}),vr(s,n,r,this.plugin.settings.relations,()=>{this.plugin.saveSettings(),this.display()}),new O.Setting(l).setName("ID").setDesc("Unique lowercase identifier used in frontmatter and inline syntax (e.g., up, parent).").addText(y=>{y.setPlaceholder("E.g., up, parent, contains").setValue(t.id).onChange(N=>{let C=mo(N);if(N&&!fo(C)){new O.Notice("Relation IDs must use lowercase letters, numbers, underscore, or dash."),y.setValue(t.id);return}if(C&&this.isDuplicateRelationId(C,r)){new O.Notice("Relation ID already exists."),y.setValue(t.id);return}let R=t.id;t.id=C,this.updateImpliedRelationTargets(R,C),this.updateGroupMemberRelations(R,C),this.plugin.saveSettings(),f.textContent=De(t)||"(unnamed)",f.toggleClass("trail-relation-name-empty",!C)})}),new O.Setting(l).setName("Display name").setDesc("Optional custom name shown in the UI. If empty, the ID is used.").addText(y=>{var N;y.setPlaceholder(t.id||"Same as ID").setValue((N=t.displayName)!=null?N:"").onChange(C=>{let R=C.trim();t.displayName=R||void 0,this.plugin.saveSettings(),f.textContent=De(t)||"(unnamed)"})}),new O.Setting(l).setName("Visual direction").setDesc("How items are displayed: descending (indent increases), ascending (indent decreases), or sequential (flat, sorted).").addDropdown(y=>{var N;y.addOption("descending","Descending (children)").addOption("ascending","Ascending (ancestors)").addOption("sequential","Sequential (flat)").setValue((N=t.visualDirection)!=null?N:"descending").onChange(C=>{t.visualDirection=C,this.plugin.saveSettings()})}),this.renderIconSetting(l,t),this.renderAliasesSubsection(l,t),this.renderImpliedSubsection(l,t),new O.Setting(l).addButton(y=>{y.setButtonText("Delete relation").setWarning().onClick(()=>{this.plugin.settings.relations.splice(r,1),this.removeImpliedRelationTargets(t.id),this.removeGroupMemberRelations(t.id),this.plugin.saveSettings(),this.display()})})}renderIconSetting(e,t){let r=new O.Setting(e).setName("Icon").setDesc("Optional Lucide icon name to display instead of the relation name. Start typing to search."),i=r.controlEl.createSpan({cls:"trail-icon-preview"});t.icon&&(0,O.setIcon)(i,t.icon);let n=s=>{i.empty(),s&&(0,O.setIcon)(i,s)};r.addText(s=>{var a;s.setPlaceholder("Search icons...").setValue((a=t.icon)!=null?a:""),new Cr(this.plugin.app,s.inputEl,l=>{t.icon=l||void 0,n(l),this.plugin.saveSettings()}),s.onChange(l=>{let c=l.trim().toLowerCase();t.icon=c||void 0,n(c),this.plugin.saveSettings()})})}renderAliasesSubsection(e,t){new O.Setting(e).setName("Aliases").setDesc("Frontmatter keys that map to this relation.");let r=e.createDiv({cls:"trail-items-list"});if(t.aliases.length===0)r.createEl("p",{text:"No aliases defined.",cls:"trail-empty-state"});else for(let[i,n]of t.aliases.entries())this.renderAliasRow(r,t,n,i);new O.Setting(e).addButton(i=>{i.setButtonText("Add alias").setCta().onClick(()=>{t.aliases.push({key:t.id||"key"}),this.plugin.saveSettings(),this.display()})})}renderAliasRow(e,t,r,i){new O.Setting(e).addText(n=>{n.setPlaceholder(t.id||"key").setValue(r.key);let s=r.key;n.onChange(a=>{s=a}),n.inputEl.addEventListener("blur",()=>{let a=s.trim().toLowerCase();if(!a){new O.Notice("Alias key cannot be empty."),n.setValue(r.key);return}a!==r.key&&(r.key=a,n.setValue(a),this.plugin.saveSettings())})}).addExtraButton(n=>{n.setIcon("trash").setTooltip("Remove alias").onClick(()=>{t.aliases.splice(i,1),this.plugin.saveSettings(),this.display()})})}renderImpliedSubsection(e,t){new O.Setting(e).setName("Implied relations").setDesc("Other relations that are automatically created when this relation exists.");let r=e.createDiv({cls:"trail-items-list"});if(t.impliedRelations.length===0)r.createEl("p",{text:"No implied relations.",cls:"trail-empty-state"});else for(let[n,s]of t.impliedRelations.entries())this.renderImpliedRow(r,t,s,n);let i=this.getRelationOptions();i.length>0?new O.Setting(e).addButton(n=>{n.setButtonText("Add implied relation").setCta().onClick(()=>{var s;t.impliedRelations.push({targetRelation:t.id||((s=i[0])!=null?s:""),direction:"reverse"}),this.plugin.saveSettings(),this.display()})}):e.createEl("p",{text:"Add more relations to create implied rules.",cls:"trail-hint"})}renderImpliedRow(e,t,r,i){new O.Setting(e).addDropdown(s=>{let a=this.getRelationOptions();for(let l of a)s.addOption(l,l);s.setValue(r.targetRelation).onChange(l=>{r.targetRelation=l,this.plugin.saveSettings()})}).addDropdown(s=>{s.addOption("forward","Forward (\u2192)").addOption("reverse","Reverse (\u2190)").addOption("both","Both (\u2194)").addOption("sibling","Sibling (\u21CC)").setValue(r.direction).onChange(a=>{r.direction=a,this.plugin.saveSettings()})}).addExtraButton(s=>{s.setIcon("trash").setTooltip("Remove implied relation").onClick(()=>{t.impliedRelations.splice(i,1),this.plugin.saveSettings(),this.display()})})}getRelationOptions(){return this.plugin.settings.relations.map(e=>e.id).filter(e=>e.length>0)}isDuplicateRelationId(e,t){return this.plugin.settings.relations.some((r,i)=>i!==t&&r.id===e)}updateImpliedRelationTargets(e,t){if(!(!e||e===t))for(let r of this.plugin.settings.relations)for(let i of r.impliedRelations)i.targetRelation===e&&(i.targetRelation=t)}removeImpliedRelationTargets(e){for(let t of this.plugin.settings.relations)t.impliedRelations=t.impliedRelations.filter(r=>r.targetRelation!==e)}updateGroupMemberRelations(e,t){if(!(!e||e===t))for(let r of this.plugin.settings.groups)for(let i of r.members)i.relation===e&&(i.relation=t)}removeGroupMemberRelations(e){for(let t of this.plugin.settings.groups)t.members=t.members.filter(r=>r.relation!==e)}renderAddRelationControl(e,t){let r=new O.Setting(e).setName("Add new relation").setDesc("Create a relation type with standard aliases."),i="";r.addText(n=>{n.setPlaceholder("E.g., parent, cites, related-to").onChange(s=>{i=s})}).addButton(n=>{n.setButtonText("Create").setCta().onClick(()=>{let s=mo(i);if(!s){new O.Notice("Relation ID cannot be empty.");return}if(!fo(s)){new O.Notice("Relation IDs must use lowercase letters, numbers, underscore, or dash.");return}if(this.isDuplicateRelationId(s,-1)){new O.Notice("Relation ID already exists.");return}let a=this.plugin.settings.relations.length;this.plugin.settings.relations.push({id:s,aliases:uo(s),impliedRelations:[]}),t.add(a),this.plugin.saveSettings(),this.display()})})}};var P=require("obsidian");var si=require("@lezer/lr");var S=require("@lezer/highlight"),ni=(0,S.styleTags)({"group from prune where when sort display":S.tags.keyword,"extend all":S.tags.typeName,":depth :flatten :asc :desc :chain":S.tags.typeName,"and or not in":S.tags.operatorKeyword,String:S.tags.string,Number:S.tags.number,Duration:S.tags.number,Boolean:S.tags.bool,Null:S.tags.null,DateLiteral:S.tags.number,"today yesterday tomorrow startOfWeek endOfWeek":S.tags.atom,Identifier:S.tags.variableName,BuiltinIdentifier:S.tags.special(S.tags.variableName),BuiltinPropertyAccess:S.tags.special(S.tags.variableName),PropertyAccess:S.tags.propertyName,RelationSpec:S.tags.variableName,GroupReference:S.tags.string,"FunctionCall/Identifier":S.tags.function(S.tags.variableName),"@":S.tags.keyword,">>":S.tags.operator,LineComment:S.tags.lineComment});var zn={__proto__:null,group:12,from:18,prune:48,not:56,all:70,true:92,false:92,null:96,today:106,yesterday:108,tomorrow:110,startOfWeek:112,endOfWeek:114,in:140,and:146,or:148,where:152,sort:156,when:166,display:170},Gr=si.LRParser.deserialize({version:14,states:"0nOYQPOOOOQO'#C_'#C_OOQO'#EW'#EWQYQPOOOqQPO'#C`OvQPO'#CsOvQPO'#DyO#QQPO'#D{O#]QPO'#CdOvQPO'#EQO#bQPO'#ESOOQO-E8U-E8UOOQO,58z,58zO#mQPO'#ClO$jQPO'#DOO%mQPO'#C}O%rQPO'#DSOOQO'#DZ'#DZOOQO'#D]'#D]OOQO'#DX'#DXOOQO'#D`'#D`O'iQPO'#D_OOQO'#Ei'#EiO)]QPO'#C{O*yQPO'#CzOvQPO'#CwOOQO'#Cw'#CwO,^QPO'#CvO-UQPO'#CuOvQPO'#C|OOQO'#DO'#DOOOQO'#Db'#DbOOQO,59_,59_OOQO,5:e,5:eO-yQPO'#DWOOQO'#EO'#EOO.TQPO'#D}O.{QPO,5:gO/mQQO'#CgO0hQQO'#CfO1]QPO,59OOOQO,5:l,5:lOOQO'#EV'#EVO1}QPO'#EUOOQO,5:n,5:nOOQO,59W,59WO2lQPO,59ZO2zQPO'#E]O3SQPO,59rO4yQPO,59iO5QQPO,59nO6wQPO'#DhOOQO,59y,59yO6|QPO'#E^O8QQPO,59gOOQO'#Ej'#EjO6|QPO,59fOOQO,59f,59fO6|QPO'#DsOOQO,59c,59cO9nQPO,59bOvQPO'#E_O:fQPO,59aOvQPO'#E`O;ZQPO,59hOOQO'#EP'#EPOOQO,5:i,5:iO#QQPO'#EaO;`QPO1G0RO<QQPO'#ChO<VQQO'#ChOOQO'#EX'#EXO=TQQO,59RO>OQPO'#EYO>WQQO,59QO#]QPO'#EbO>{QPO1G.jO?mQPO'#EcO?uQPO,5:pOOQO'#Cr'#CrOOQO'#EZ'#EZO@dQPO'#CqO@uQPO1G.uOOQO'#DV'#DVOOQO,5:w,5:wOOQO-E8Z-E8ZOOQO1G/T1G/TO@zQPO1G/TOAPQPO'#DQOOQO,5:S,5:SOOQO,5:x,5:xOOQO-E8[-E8[OOQO1G/Q1G/QOAXQPO,5:_OOQO-E8]-E8]OOQO,5:y,5:yOOQO-E8^-E8^OOQO,5:z,5:zOOQO1G/S1G/SOOQO,5:{,5:{OOQO-E8_-E8_OOQO,59S,59SOOQO-E8V-E8VOOQO'#Ck'#CkOOQO,5:t,5:tOOQO-E8W-E8WOOQO,5:|,5:|OOQO-E8`-E8`OOQO,5:},5:}OOQO-E8a-E8aOOQO-E8X-E8XOOQO7+$a7+$aOOQO7+$o7+$oOBSQPO,59lOvQPO'#E[O6|QPO'#DuOOQO1G/y1G/yOOQO-E8Y-E8YOOQO,5:v,5:vOOQO,5:a,5:a",stateData:"Bm~O#YOSPOS~OUSOXWOhTO!nUO!pVO!uXO!wYO~OV[O~OT^OVcO]cOa]OdmOliOmiOsnOw`O|cO!OaO!QbO!TdO!VoO!WoO!XoO!YoO!ZoO~OTrOw`O#_sO~OTvO~OTrOs{Ow`O~OV}Od!OO~Ox!POUzXXzXhzX!nzX!pzX!uzX!wzX#WzXbzXuzX~OdrX!]zX!^zX!_zX!`zX!azX!bzX!czX!dzX!ezX!fzX!hzX!kzX!lzX!jzX~P#uOd!RO~Ox!POUvXXvXhvX!]vX!^vX!_vX!`vX!avX!bvX!cvX!dvX!evX!fvX!hvX!kvX!lvX!nvX!pvX!uvX!wvX#WvXuvX#`vX#avXbvX!jvX~O!]!TO!^!TOU!RXX!RXh!RX!]!RX!^!RX!_!RX!`!RX!a!RX!b!RX!c!RX!d!RX!e!RX!f!RX!h!RX!k!RX!l!RX!n!RX!p!RX!u!RX!w!RX#W!RXb!RXu!RX!j!RX~O!]!VO!^!VOUoXXoXhoX!_oX!`oX!aoX!boX!coX!doX!eoX!foX!hoX!koX!loX!noX!poX!uoX!woX#WoXboXuoX!joX~O!_!XO!`!XO!a!XO!b!XO!c!XO!d!XO!e!XO!f!XO!h![OUnXXnXhnX!knX!lnX!nnX!pnX!unX!wnX#WnXbnXunX~O!k!_OUjXXjXhjX!ljX!njX!pjX!ujX!wjX#WjXbjXujX~O!l!aOUiXXiXhiX!niX!piX!uiX!wiX#WiXbiXuiX~O#`zX#azX~P#uO#`!cO#a!cOU!qXX!qXh!qXu!qX!n!qX!p!qX!u!qX!w!qX#W!qXb!qX~Ou!eOU!oaX!oah!oa!n!oa!p!oa!u!oa!w!oa#W!oab!oa~O#Z!gO#[!hOUZXXZX^ZXhZXuZX!nZX!pZX!uZX!wZX#WZXbZX~O^!kOUYXXYXhYXuYX!nYX!pYX!uYX!wYX#WYXbYX~Ou!mOUWaXWahWa!nWa!pWa!uWa!wWa#WWabWa~Ou!oOU!xXX!xXh!xX!n!xX!p!xX!u!xX!w!xX#W!xX~OXWOhTO!nUO!pVO~OT!uOV!uO~Ox!POUzaXzahza!]za!^za!_za!`za!aza!bza!cza!dza!eza!fza!hza!kza!lza!nza!pza!uza!wza#Wzauza#`za#azabza!jza~Ob!xO~PvOx!POUvaXvahva!]va!^va!_va!`va!ava!bva!cva!dva!eva!fva!hva!kva!lva!nva!pva!uva!wva#Wvauva#`va#avabva!jva~O|!{O~OT^OVcO]cOa]OdmOsnOw`O|cO!OaO!QbO!TdO!VoO!WoO!XoO!YoO!ZoO~O!]!VO!^!VOUoaXoahoa!_oa!`oa!aoa!boa!coa!doa!eoa!foa!hoa!koa!loa!noa!poa!uoa!woa#Woaboauoa!joa~O!k!_OUjaXjahja!lja!nja!pja!uja!wja#Wjabjauja~O!l!aOUiaXiahia!nia!pia!uia!wia#Wiabiauia~Ob#UO~Ou!eOU!oiX!oih!oi!n!oi!p!oi!u!oi!w!oi#W!oib!oi~O]#XO~O]#XOU[XX[X^[Xh[Xu[X!n[X!p[X!u[X!w[X#W[X#Z[X#[[Xb[X~O#Z!gO#[!hOUZaXZa^ZahZauZa!nZa!pZa!uZa!wZa#WZabZa~OTvOa]O~O^!kOUYaXYahYauYa!nYa!pYa!uYa!wYa#WYabYa~Ou!mOUWiXWihWi!nWi!pWi!uWi!wWi#WWibWi~OTrOw`O~Ou!oOU!xaX!xah!xa!n!xa!p!xa!u!xa!w!xa#W!xa~OXWOhTO!nUO!pVObeX~Ob#cO~Ob#dO~Ou#fObtX~O!j#gOU!gaX!gah!ga!k!ga!l!ga!n!ga!p!ga!u!ga!w!ga#W!gab!gau!ga~Ou#fObta~O|!T]^u!jx!d!b!c!a!e!_!f!`m~",goto:"+`#_PPP#`#dPPP#hP#p#v#}PP$R$UPP$UP$h$k#hP$o%R%^PP%m%x&^&^&mP&|P'PPP'h'P&^P'kP'kP&^'zP(ZPPPPP(jPPPPPPPPPP(mP(pPPP#hP#hP(s(y(}#dP#dP)Q)T)Z)a)g)m)s)y*U*[*b*h*n*tPPPPP*z+]TQORTPORSPORT!q!O!sQxWR#^!mSwW!mR#Z!kT!iv!jR#[!kjfTUXim!R!V!Y![!_!a#f#gR#Z!kR!t!OT!r!O!sQpTQqUQyXQ!bmQ!z!RR#j#f[lTUXm!R#fR#T!a^kTUXm!R!a#fQ!]iR#R!_cjTUXim!R!_!a#fbhTUXim!R!_!a#fQ#O!YQ#P![R#k#gkfTUXim!R!V!Y![!_!a#f#gk_TUXim!R!V!Y![!_!a#f#gR!y!RjfTUXim!R!V!Y![!_!a#f#gSsV!eTzY!oR!v!PkcTUXim!R!V!Y![!_!a#f#gkeTUXim!R!V!Y![!_!a#f#gkdTUXim!R!V!Y![!_!a#f#gR!UeR!ZhR#h#PQuVR#V!eTtV!eR!dtR|YQ{YR#`!oQRORZRQ!jvR#Y!jQ!lwR#]!lQ!s!OR#b!sQ#e!zR#i#eS!Q^rQ!S`T!w!Q!SQ!WgR!}!WQ!^kR#Q!^Q!`lR#S!`Q!fuR#W!fQ!nxR#_!nQ!p{R#a!phgTUXim!R!Y![!_!a#f#gR!|!VR!Yh",nodeNames:"\u26A0 LineComment Query QueryClause Group Identifier group String From from RelationChain RelationSpec RelationOption Number >> ChainTarget GroupReference @ ) InlineQuery ( InlineQueryBody InlineClause Prune prune OrExpr AndExpr NotExpr not ! CompareExpr ArithExpr ParenExpr FunctionCall FunctionName all ArgList , BuiltinPropertyAccess BuiltinIdentifier . PropertySegment PropertyAccess SimpleLiteral Duration Boolean Boolean Null Null DateExpr DateBase DateLiteral RelativeDate today yesterday tomorrow startOfWeek endOfWeek DateOffset + - = != < > <= >= =? !=? InExpr in RangeExpr .. and or Where where Sort sort SortKey SortKeyExpr SortDirection When when Display display DisplayList DisplayItem",maxTerm:109,nodeProps:[["openedBy",18,"("],["closedBy",20,")"]],propSources:[ni],skippedNodes:[0,1],repeatNodeCount:12,tokenData:"2n~RqX^#Ypq#Yqr#}rs$dtu&Qxy'[yz'a{|'f|}'k}!O'p!O!P'u!P!Q(S!Q![(q![!]-o!^!_0v!_!`1T!`!a1b!b!c1w!c!}1|#R#S1|#T#o1|#y#z#Y$f$g#Y%W&j1|7l9O1|#BY#BZ#Y$IS$I_#Y$I|$JO#Y$JT$JU#Y$KV$KW#Y% U% V1|&FU&FV#Y*5S4/p1|~#_Y#Y~X^#Ypq#Y#y#z#Y$f$g#Y#BY#BZ#Y$IS$I_#Y$I|$JO#Y$JT$JU#Y$KV$KW#Y&FU&FV#Y~$SPm~!_!`$V~$[P!`~!a!b$_~$dO!f~~$gVOr$drs$|s#O$d#O#P%R#P;'S$d;'S;=`%z<%lO$d~%ROV~~%URO;'S$d;'S;=`%_;=`O$d~%bWOr$drs$|s#O$d#O#P%R#P;'S$d;'S;=`%z;=`<%l$d<%lO$d~%}P;=`<%l$d~&TV!c!}&j#R#S&j#T#o&j%W&j&j7l9O&j% U% V&j*5S4/p&j~&oXw~}!O&j!Q![&j!c!}&j#R#S&j#T#o&j%W&j&j7l9O&j% U% V&j*5S4/p&j~'aOd~~'fOb~~'kO!]~~'pOu~~'uO!^~~'zPx~!O!P'}~(SO!j~~(VP!P!Q(Y~(_SP~OY(YZ;'S(Y;'S;=`(k<%lO(Y~(nP;=`<%l(Y~(vU]~!O!P)Y!Q![)h#W#X-j#a#b-j#k#l-j#m#n-j~)]P!Q![)`~)eP]~!Q![)`~)mU]~!O!P)Y!Q![*P#W#X-j#a#b-j#k#l-j#m#n-j~*UU]~!O!P)Y!Q![*h#W#X-j#a#b-j#k#l-j#m#n-j~*mV]~}!O+S!O!P)Y!Q![-R#W#X-j#a#b-j#k#l-j#m#n-j~+VP!Q![+Y~+]P!Q![+`~+cP}!O+f~+iP!Q![+l~+oP!Q![+r~+wP!T~!v!w+z~+}P!Q![,Q~,TP!Q![,W~,ZP![!],^~,aP!Q![,d~,gP!Q![,j~,mP![!],p~,sP!Q![,v~,yP!Q![,|~-RO!T~~-WU]~!O!P)Y!Q![-R#W#X-j#a#b-j#k#l-j#m#n-j~-oO|~~-rS#T#U.O#V#W.a#W#X/O#Y#Z/{~.RP#g#h.U~.XP#V#W.[~.aO#`~~.dP#[#].g~.jP#T#U.m~.pP#]#^.s~.vP#b#c.y~/OO#_~~/RP#X#Y/U~/XQ#d#e/_#g#h/p~/bP#h#i/e~/hP#[#]/k~/pO#Z~~/sP#V#W/v~/{O#a~~0OP#`#a0R~0UP#T#U0X~0[P#h#i0_~0bP#h#i0e~0hP#X#Y0k~0nP#b#c0q~0vO#[~~0{P!a~!_!`1O~1TO!c~~1YP!_~!a!b1]~1bO!e~~1gQ!bP!_!`1m!`!a1r~1rO!d~Q1wO^Q~1|Oa~~2RXT~}!O1|!Q![1|!c!}1|#R#S1|#T#o1|%W&j1|7l9O1|% U% V1|*5S4/p1|",tokenizers:[0,1],topRules:{Query:[0,2]},specialized:[{term:5,get:o=>zn[o]||-1}],tokenPrec:1530});var go=class{constructor(){this.nodesByType=new Map;this.tokensByKeyword=new Map;this.modifiersByKeyword=new Map;this.exprNodes=new Map;this.functionsByName=new Map;this.completableNodes=new Map;this.builtinsByName=new Map;this.clauseNodes=new Map;this.contextProviders=new Map;this.clauseLezerNames=new Set}register(e,t){this.nodesByType.set(e,t),t.completable&&this.completableNodes.set(e,t)}registerClause(e,t){var n;this.clauseNodes.set(e,t),this.register(e,t);let r=e.replace(/Node$/,"");this.clauseLezerNames.add(r);let i=t;(n=i.providesContexts)!=null&&n.length&&this.contextProviders.set(r,i.providesContexts)}registerToken(e,t){this.tokensByKeyword.set(e.toLowerCase(),t),t.completable&&this.completableNodes.set(e,t)}registerModifier(e,t){this.modifiersByKeyword.set(e.toLowerCase(),t),t.completable&&this.completableNodes.set(e,t)}getModifierClass(e){return this.modifiersByKeyword.get(e.toLowerCase())}getAllModifierClasses(){return Array.from(this.modifiersByKeyword.values())}registerExpr(e,t){var n;this.exprNodes.set(e,t),this.nodesByType.set(e,t),t.completable&&this.completableNodes.set(e,t);let i=t;if((n=i.providesContexts)!=null&&n.length){let s=e.replace(/Node$/,"");this.contextProviders.set(s,i.providesContexts)}}registerFunction(e,t){this.functionsByName.set(e.toLowerCase(),t),this.nodesByType.set(t.name,t),this.exprNodes.set(t.name,t),t.completable&&this.completableNodes.set(e,t)}registerBuiltin(e,t){this.builtinsByName.set(e,t)}getNodeClass(e){return this.nodesByType.get(e)}getTokenClass(e){return this.tokensByKeyword.get(e.toLowerCase())}getExprClass(e){return this.exprNodes.get(e)}getFunctionClass(e){return this.functionsByName.get(e.toLowerCase())}hasFunction(e){return this.functionsByName.has(e.toLowerCase())}getAllFunctionNames(){return Array.from(this.functionsByName.keys())}getAllFunctionClasses(){return new Map(this.functionsByName)}getBuiltinClass(e){return this.builtinsByName.get(e)}getAllBuiltinClasses(){return new Map(this.builtinsByName)}getAllNodeClasses(){return Array.from(this.nodesByType.values())}getAllTokenClasses(){return Array.from(this.tokensByKeyword.values())}getAllExprClasses(){return Array.from(this.exprNodes.values())}hasToken(e){return this.tokensByKeyword.has(e.toLowerCase())}getCompletablesForContext(e){let t=[];for(let r of this.completableNodes.values()){let i=r.completable;if(!i)continue;(Array.isArray(i.context)?i.context:[i.context]).includes(e)&&t.push(r)}return t.sort((r,i)=>{var n,s,a,l;return((s=(n=i.completable)==null?void 0:n.priority)!=null?s:0)-((l=(a=r.completable)==null?void 0:a.priority)!=null?l:0)})}getAllCompletables(){return Array.from(this.completableNodes.values())}getAllClauseTypes(){return Array.from(this.clauseNodes.keys())}getExpressionClauseLezerNames(){let e=new Set;for(let[t,r]of this.clauseNodes)if(typeof r.prototype.test=="function"){let n=t.replace(/Node$/,"");e.add(n)}return e}getExpressionNodeLezerNames(){let e=new Set,t=["OrExpr","AndExpr","NotExpr","CompareExpr","ArithExpr","ParenExpr","FunctionCall","PropertyAccess","InExpr"];for(let r of t)e.add(r);return e}getProvidedContexts(e){return this.contextProviders.get(e)}isClause(e){return this.clauseLezerNames.has(e)}},M=new go;function p(o,e){return function(t){if(e!=null&&e.modifier){let r=t,i=r.keyword;return i&&M.registerModifier(i,r),t}return M.register(o,t),e!=null&&e.keyword&&M.registerToken(e.keyword,t),e!=null&&e.expr&&M.registerExpr(o,t),e!=null&&e.function&&M.registerFunction(e.function,t),e!=null&&e.clause&&M.registerClause(o,t),e!=null&&e.builtin&&M.registerBuiltin(e.builtin,t),t}}function ai(o){return M.getFunctionClass(o)}function li(){return M.getAllBuiltinClasses()}var U=class{constructor(e){this.span=e}};var E=class extends U{constructor(e){super(e)}};var x=class extends E{constructor(e,t){super(t),this.args=e}validate(e){for(let t of this.args)t.validate(e)}evaluateArgs(e){return this.args.map(t=>t.evaluate(e))}};x.highlighting="function";function v(o){return o===null?"":typeof o=="string"?o:typeof o=="number"||typeof o=="boolean"?String(o):o instanceof Date?o.toISOString():Array.isArray(o)?o.map(v).join(","):String(o)}var Te=class extends x{constructor(e,t){super(e,t)}evaluate(e){var n,s;let t=this.evaluateArgs(e),r=v((n=t[0])!=null?n:null),i=v((s=t[1])!=null?s:null);return r.includes(i)}};Te.minArity=2,Te.maxArity=2,Te.documentation={title:"contains",description:"Check if string contains substring (case-sensitive).",syntax:"contains(haystack, needle)",returnType:"boolean",examples:['contains(title, "draft")','contains(file.name, "project")']},Te=u([p("ContainsNode",{function:"contains"})],Te);var Pe=class extends x{constructor(e,t){super(e,t)}evaluate(e){var n,s;let t=this.evaluateArgs(e),r=v((n=t[0])!=null?n:null),i=v((s=t[1])!=null?s:null);return r.startsWith(i)}};Pe.minArity=2,Pe.maxArity=2,Pe.documentation={title:"startsWith",description:"Check if string starts with prefix.",syntax:"startsWith(string, prefix)",returnType:"boolean",examples:['startsWith(file.name, "2024")']},Pe=u([p("StartsWithNode",{function:"startsWith"})],Pe);var ke=class extends x{constructor(e,t){super(e,t)}evaluate(e){var n,s;let t=this.evaluateArgs(e),r=v((n=t[0])!=null?n:null),i=v((s=t[1])!=null?s:null);return r.endsWith(i)}};ke.minArity=2,ke.maxArity=2,ke.documentation={title:"endsWith",description:"Check if string ends with suffix.",syntax:"endsWith(string, suffix)",returnType:"boolean",examples:['endsWith(file.name, "2024")']},ke=u([p("EndsWithNode",{function:"endsWith"})],ke);var Qe=class extends x{constructor(e,t){super(e,t)}evaluate(e){var i;let r=(i=this.evaluateArgs(e)[0])!=null?i:null;return r===null?0:typeof r=="string"||Array.isArray(r)?r.length:v(r).length}};Qe.minArity=1,Qe.maxArity=1,Qe.documentation={title:"length",description:"Get string length. Also works on arrays.",syntax:"length(string)",returnType:"number",examples:["length(title)","length(tags)"]},Qe=u([p("LengthNode",{function:"length"})],Qe);var Ve=class extends x{constructor(e,t){super(e,t)}evaluate(e){var r;let t=this.evaluateArgs(e);return v((r=t[0])!=null?r:null).toLowerCase()}};Ve.minArity=1,Ve.maxArity=1,Ve.documentation={title:"lower",description:"Convert string to lowercase.",syntax:"lower(string)",returnType:"string",examples:['lower(status) = "active"']},Ve=u([p("LowerNode",{function:"lower"})],Ve);var Ae=class extends x{constructor(e,t){super(e,t)}evaluate(e){var r;let t=this.evaluateArgs(e);return v((r=t[0])!=null?r:null).toUpperCase()}};Ae.minArity=1,Ae.maxArity=1,Ae.documentation={title:"upper",description:"Convert string to uppercase.",syntax:"upper(string)",returnType:"string",examples:['upper(type) = "PROJECT"']},Ae=u([p("UpperNode",{function:"upper"})],Ae);var Le=class extends x{constructor(e,t){super(e,t)}evaluate(e){var r;let t=this.evaluateArgs(e);return v((r=t[0])!=null?r:null).trim()}};Le.minArity=1,Le.maxArity=1,Le.documentation={title:"trim",description:"Remove leading and trailing whitespace.",syntax:"trim(string)",returnType:"string",examples:["trim(title)"]},Le=u([p("TrimNode",{function:"trim"})],Le);var Me=class extends x{constructor(e,t){super(e,t)}evaluate(e){var n,s;let t=this.evaluateArgs(e),r=v((n=t[0])!=null?n:null),i=v((s=t[1])!=null?s:null);return r.split(i)}};Me.minArity=2,Me.maxArity=2,Me.documentation={title:"split",description:"Split string into array by delimiter.",syntax:"split(string, delimiter)",returnType:"array",examples:['split(path, "/")','split(tags_string, ",")']},Me=u([p("SplitNode",{function:"split"})],Me);var Ie=class extends x{constructor(e,t){super(e,t)}evaluate(e){var s,a;let t=this.evaluateArgs(e),r=v((s=t[0])!=null?s:null),i=v((a=t[1])!=null?a:null),n=t[2]!==void 0?v(t[2]):"";try{return new RegExp(i,n).test(r)}catch(l){return!1}}};Ie.minArity=2,Ie.maxArity=3,Ie.documentation={title:"matches",description:"Test string against regex pattern. Optional flags parameter.",syntax:"matches(string, pattern[, flags])",returnType:"boolean",examples:['matches(title, "^\\\\d{4}")','matches(name, "test", "i")']},Ie=u([p("MatchesNode",{function:"matches"})],Ie);var Xe=class extends x{constructor(e,t){super(e,t)}evaluate(e){var s;let t=this.evaluateArgs(e),r=v((s=t[0])!=null?s:null),i=e.getFileMetadata(e.filePath);if(!i)return!1;let n=i.folder;return n===r||n.startsWith(r+"/")}};Xe.minArity=1,Xe.maxArity=1,Xe.documentation={title:"inFolder",description:"Check if current file is in the specified folder (or a subfolder).",syntax:"inFolder(folder)",returnType:"boolean",examples:['inFolder("Projects")','inFolder("Archive/2024")']},Xe=u([p("InFolderNode",{function:"inFolder"})],Xe);var Be=class extends x{constructor(e,t){super(e,t)}evaluate(e){var s;let t=this.evaluateArgs(e),r=v((s=t[0])!=null?s:null).toLowerCase(),i=e.filePath.toLowerCase(),n=r.startsWith(".")?r:"."+r;return i.endsWith(n)}};Be.minArity=1,Be.maxArity=1,Be.documentation={title:"hasExtension",description:"Check if file has the specified extension.",syntax:"hasExtension(ext)",returnType:"boolean",examples:['hasExtension("md")','hasExtension("pdf")']},Be=u([p("HasExtensionNode",{function:"hasExtension"})],Be);var $e=class extends x{constructor(e,t){super(e,t)}evaluate(e){var s;let t=this.evaluateArgs(e),r=v((s=t[0])!=null?s:null),i=e.getFileMetadata(e.filePath);if(!i)return!1;let n=r.startsWith("#")?r.slice(1):r;return i.tags.some(a=>(a.startsWith("#")?a.slice(1):a).toLowerCase()===n.toLowerCase())}};$e.minArity=1,$e.maxArity=1,$e.documentation={title:"hasTag",description:"Check if file has the specified tag.",syntax:"hasTag(tag)",returnType:"boolean",examples:['hasTag("project")','hasTag("active")']},$e=u([p("HasTagNode",{function:"hasTag"})],$e);var qe=class extends x{constructor(e,t){super(e,t)}evaluate(e){let t=e.getFileMetadata(e.filePath);return t?t.tags:[]}};qe.minArity=0,qe.maxArity=0,qe.documentation={title:"tags",description:"Get all tags from the current file.",syntax:"tags()",returnType:"array",examples:['"project" in tags()',"length(tags()) > 0"]},qe=u([p("TagsNode",{function:"tags"})],qe);var Ge=class extends x{constructor(e,t){super(e,t)}evaluate(e){var n;let t=this.evaluateArgs(e),r=v((n=t[0])!=null?n:null).toLowerCase(),i=e.getFileMetadata(e.filePath);return i?i.links.some(s=>s.toLowerCase().includes(r)):!1}};Ge.minArity=1,Ge.maxArity=1,Ge.documentation={title:"hasLink",description:"Check if file contains a link to the specified target.",syntax:"hasLink(target)",returnType:"boolean",examples:['hasLink("Index")','hasLink("Projects/Main")']},Ge=u([p("HasLinkNode",{function:"hasLink"})],Ge);var Fe=class extends x{constructor(e,t){super(e,t)}evaluate(e){let t=e.getFileMetadata(e.filePath);return t?t.backlinks:[]}};Fe.minArity=0,Fe.maxArity=0,Fe.documentation={title:"backlinks",description:"Get list of files that link to the current file.",syntax:"backlinks()",returnType:"array",examples:["length(backlinks()) > 5"]},Fe=u([p("BacklinksNode",{function:"backlinks"})],Fe);var We=class extends x{constructor(e,t){super(e,t)}evaluate(e){let t=e.getFileMetadata(e.filePath);return t?t.links:[]}};We.minArity=0,We.maxArity=0,We.documentation={title:"outlinks",description:"Get list of files that the current file links to.",syntax:"outlinks()",returnType:"array",examples:["length(outlinks()) > 0"]},We=u([p("OutlinksNode",{function:"outlinks"})],We);var _e=class extends x{constructor(e,t){super(e,t)}evaluate(e){var i;let r=(i=this.evaluateArgs(e)[0])!=null?i:null;return r===null?0:Array.isArray(r)||typeof r=="string"?r.length:0}};_e.minArity=1,_e.maxArity=1,_e.documentation={title:"len",description:"Get array length.",syntax:"len(array)",returnType:"number",examples:["len(tags)","len(children)"]},_e=u([p("LenNode",{function:"len"})],_e);var ze=class extends x{constructor(e,t){super(e,t)}evaluate(e){var i,n;let r=(i=this.evaluateArgs(e)[0])!=null?i:null;return Array.isArray(r)&&r.length>0&&(n=r[0])!=null?n:null}};ze.minArity=1,ze.maxArity=1,ze.documentation={title:"first",description:"Get first element of array.",syntax:"first(array)",returnType:"any",examples:['first(tags) = "important"']},ze=u([p("FirstNode",{function:"first"})],ze);var je=class extends x{constructor(e,t){super(e,t)}evaluate(e){var i,n;let r=(i=this.evaluateArgs(e)[0])!=null?i:null;return Array.isArray(r)&&r.length>0&&(n=r[r.length-1])!=null?n:null}};je.minArity=1,je.maxArity=1,je.documentation={title:"last",description:"Get last element of array.",syntax:"last(array)",returnType:"any",examples:["last(path_parts)"]},je=u([p("LastNode",{function:"last"})],je);var Ue=class extends x{constructor(e,t){super(e,t)}evaluate(e){var i;let r=(i=this.evaluateArgs(e)[0])!=null?i:null;return r===null?!0:Array.isArray(r)||typeof r=="string"?r.length===0:!0}};Ue.minArity=1,Ue.maxArity=1,Ue.documentation={title:"isEmpty",description:"Check if array is empty.",syntax:"isEmpty(array)",returnType:"boolean",examples:["isEmpty(tags)","not isEmpty(children)"]},Ue=u([p("IsEmptyNode",{function:"isEmpty"})],Ue);var He=class extends x{constructor(e,t){super(e,t)}evaluate(e){let r=this.evaluateArgs(e)[0];return r!=null}};He.minArity=1,He.maxArity=1,He.documentation={title:"exists",description:"Check if value is not null/undefined.",syntax:"exists(value)",returnType:"boolean",examples:["exists(due)","exists(priority)"]},He=u([p("ExistsNode",{function:"exists"})],He);var Ye=class extends x{constructor(e,t){super(e,t)}evaluate(e){let t=this.evaluateArgs(e);for(let r of t)if(r!=null)return r;return null}};Ye.minArity=1,Ye.maxArity=1/0,Ye.documentation={title:"coalesce",description:"Return first non-null value from arguments.",syntax:"coalesce(value1, value2, ...)",returnType:"any",examples:["coalesce(alias, file.name)","coalesce(due, created)"]},Ye=u([p("CoalesceNode",{function:"coalesce"})],Ye);var Ke=class extends x{constructor(e,t){super(e,t)}evaluate(e){var n;let t=this.evaluateArgs(e),r=t[0],i=(n=t[1])!=null?n:null;return r!=null?r:i}};Ke.minArity=2,Ke.maxArity=2,Ke.documentation={title:"ifnull",description:"Return default value if first argument is null.",syntax:"ifnull(value, default)",returnType:"any",examples:['ifnull(status, "unknown")',"ifnull(priority, 0)"]},Ke=u([p("IfNullNode",{function:"ifnull"})],Ke);var Ze=class extends x{constructor(e,t){super(e,t)}evaluate(e){return new Date}};Ze.minArity=0,Ze.maxArity=0,Ze.documentation={title:"now",description:"Get current date and time.",syntax:"now()",returnType:"date",examples:["file.modified > now() - 7d"]},Ze=u([p("NowNode",{function:"now"})],Ze);var Je=class extends x{constructor(e,t){super(e,t)}evaluate(e){var n;let t=this.evaluateArgs(e),r=v((n=t[0])!=null?n:null),i=new Date(r);return isNaN(i.getTime())?null:i}};Je.minArity=1,Je.maxArity=1,Je.documentation={title:"date",description:"Parse string to date.",syntax:"date(string)",returnType:"date",examples:['date("2024-01-15")',"date(created_string)"]},Je=u([p("DateNode",{function:"date"})],Je);var et=class extends x{constructor(e,t){super(e,t)}evaluate(e){var i;let r=(i=this.evaluateArgs(e)[0])!=null?i:null;return r instanceof Date?r.getFullYear():null}};et.minArity=1,et.maxArity=1,et.documentation={title:"year",description:"Get year from date.",syntax:"year(date)",returnType:"number",examples:["year(file.created) = 2024"]},et=u([p("YearNode",{function:"year"})],et);var tt=class extends x{constructor(e,t){super(e,t)}evaluate(e){var i;let r=(i=this.evaluateArgs(e)[0])!=null?i:null;return r instanceof Date?r.getMonth()+1:null}};tt.minArity=1,tt.maxArity=1,tt.documentation={title:"month",description:"Get month from date (1-12).",syntax:"month(date)",returnType:"number",examples:["month(due) = 6"]},tt=u([p("MonthNode",{function:"month"})],tt);var rt=class extends x{constructor(e,t){super(e,t)}evaluate(e){var i;let r=(i=this.evaluateArgs(e)[0])!=null?i:null;return r instanceof Date?r.getDate():null}};rt.minArity=1,rt.maxArity=1,rt.documentation={title:"day",description:"Get day of month from date.",syntax:"day(date)",returnType:"number",examples:["day(due) = 15"]},rt=u([p("DayNode",{function:"day"})],rt);var ot=class extends x{constructor(e,t){super(e,t)}evaluate(e){var i;let r=(i=this.evaluateArgs(e)[0])!=null?i:null;return r instanceof Date?r.getDay():null}};ot.minArity=1,ot.maxArity=1,ot.documentation={title:"weekday",description:"Get day of week (0=Sunday, 6=Saturday).",syntax:"weekday(date)",returnType:"number",examples:["weekday(due) = 1  // Monday"]},ot=u([p("WeekdayNode",{function:"weekday"})],ot);var it=class extends x{constructor(e,t){super(e,t)}evaluate(e){var i;let r=(i=this.evaluateArgs(e)[0])!=null?i:null;return r instanceof Date?r.getHours():null}};it.minArity=1,it.maxArity=1,it.documentation={title:"hours",description:"Get hours from date (0-23).",syntax:"hours(date)",returnType:"number",examples:["hours(file.modified) < 12  // morning"]},it=u([p("HoursNode",{function:"hours"})],it);var nt=class extends x{constructor(e,t){super(e,t)}evaluate(e){var i;let r=(i=this.evaluateArgs(e)[0])!=null?i:null;return r instanceof Date?r.getMinutes():null}};nt.minArity=1,nt.maxArity=1,nt.documentation={title:"minutes",description:"Get minutes from date (0-59).",syntax:"minutes(date)",returnType:"number",examples:["minutes(time)"]},nt=u([p("MinutesNode",{function:"minutes"})],nt);var st=class extends x{constructor(e,t){super(e,t)}evaluate(e){var s,a;let t=this.evaluateArgs(e),r=(s=t[0])!=null?s:null,i=v((a=t[1])!=null?a:null);if(!(r instanceof Date))return null;let n=l=>l.toString().padStart(2,"0");return i.replace("YYYY",r.getFullYear().toString()).replace("MM",n(r.getMonth()+1)).replace("DD",n(r.getDate())).replace("HH",n(r.getHours())).replace("mm",n(r.getMinutes())).replace("ss",n(r.getSeconds()))}};st.minArity=2,st.maxArity=2,st.documentation={title:"format",description:"Format date as string. Supports: YYYY, MM, DD, HH, mm, ss.",syntax:"format(date, pattern)",returnType:"string",examples:['format(due, "YYYY-MM-DD")','format(time, "HH:mm")']},st=u([p("FormatNode",{function:"format"})],st);var at=class extends x{constructor(e,t){super(e,t)}evaluate(e){var g,y,N;let t=this.evaluateArgs(e),r=(g=t[0])!=null?g:null,i=(y=t[1])!=null?y:null,n=v((N=t[2])!=null?N:null);if(!(r instanceof Date)||!(i instanceof Date))return null;let s=r.getTime()-i.getTime(),a=60*1e3,l=60*a,c=24*l,m=7*c,d=30*c,f=365*c;switch(n.toLowerCase()){case"min":case"minute":case"minutes":return Math.floor(s/a);case"h":case"hour":case"hours":return Math.floor(s/l);case"d":case"day":case"days":return Math.floor(s/c);case"w":case"week":case"weeks":return Math.floor(s/m);case"m":case"month":case"months":return Math.floor(s/d);case"y":case"year":case"years":return Math.floor(s/f);default:return Math.floor(s/c)}}};at.minArity=3,at.maxArity=3,at.documentation={title:"dateDiff",description:"Get difference between dates in specified unit (d, w, m, y, h, min).",syntax:"dateDiff(date1, date2, unit)",returnType:"number",examples:['dateDiff(due, today, "d") < 7','dateDiff(created, now(), "m")']},at=u([p("DateDiffNode",{function:"dateDiff"})],at);var Ct=class extends U{constructor(e){super(e)}validate(e){}};var Yt=class extends Ct{};Yt.properties=[{name:"name",type:"string",description:"File name without extension"},{name:"path",type:"string",description:"Full file path"},{name:"folder",type:"string",description:"Parent folder path"},{name:"created",type:"date",description:"File creation date"},{name:"modified",type:"date",description:"Last modification date"},{name:"size",type:"number",description:"File size in bytes"},{name:"tags",type:"array",description:"File tags"}],Yt.documentation={title:"$file",description:"File metadata namespace",syntax:"$file.property",examples:["$file.name","$file.modified","$file.tags"]},Yt=u([p("FileBuiltin",{builtin:"$file"})],Yt);var Kt=class extends Ct{};Kt.properties=[{name:"depth",type:"number",description:"Depth from active file"},{name:"relation",type:"string",description:"Relation that led here"},{name:"isImplied",type:"boolean",description:"Whether edge is implied"},{name:"parent",type:"string",description:"Parent node path"},{name:"path",type:"array",description:"Full path from root"}],Kt.documentation={title:"$traversal",description:"Traversal context namespace",syntax:"$traversal.property",examples:["$traversal.depth","$traversal.relation"]},Kt=u([p("TraversalBuiltin",{builtin:"$traversal"})],Kt);var Zt=class extends Ct{};Zt.properties=[],Zt.documentation={title:"$chain",description:"Sort by sequence position in traversal chain",syntax:"$chain",examples:["$chain"]},Zt=u([p("ChainBuiltin",{builtin:"$chain"})],Zt);function wt(){let o=[];for(let e of Jt())for(let t of e.properties)o.push({name:`${e.name}.${t.name}`,type:t.type,description:t.description});return o}function Jt(){var e,t,r;let o=[];for(let[i,n]of li()){let s=(e=n.properties)!=null?e:[],a=(r=(t=n.documentation)==null?void 0:t.description)!=null?r:"Built-in identifier";o.push({name:i,description:a,properties:s})}return o}var T=class extends U{constructor(e){super(e)}};var ho={evaluate:()=>({include:!0,traverse:!0})};function pi(...o){return o.length===0?{evaluate:()=>({include:!0,traverse:!0})}:o.length===1?o[0]:{evaluate(e){let t=!0,r=!0;for(let i of o){let n=i.evaluate(e);if(t=t&&n.include,r=r&&n.traverse,!t&&!r)break}return{include:t,traverse:r}}}}function ui(o,e){return{evaluate(t){e.setCurrentFile(t.path,t.properties),e.setTraversal(t.traversalCtx);let r=o.evaluate(e);return e.isTruthy(r)?{include:!1,traverse:!1}:{include:!0,traverse:!0}}}}function yo(o,e){let t=[];return e.pruneExpr&&t.push(ui(e.pruneExpr,o)),pi(...t)}var br=class{constructor(e){this.flatResults=[];this.warnings=[];this.ancestors=new Set([e.startPath]),this.path=[e.startPath],this.output=e.output,this.relation=e.relation}isAncestor(e){return this.ancestors.has(e)}currentPath(){return this.path[this.path.length-1]}getTraversalPath(){return[...this.path]}enterNode(e){this.path.push(e),this.ancestors.add(e)}exitNode(){let e=this.path.pop();e&&this.ancestors.delete(e)}snapshotAncestors(){return new Set(this.ancestors)}buildNodeContext(e,t,r,i){let n=[...this.path,e.toPath],s={depth:t,relation:e.relation,isImplied:e.implied,parent:this.currentPath(),path:n};return{path:e.toPath,edge:e,depth:t,parent:this.currentPath(),traversalPath:n,properties:r,traversalCtx:s,visualDirection:i}}buildResultNode(e,t){let{flattenFrom:r}=this.output,i={path:e.path,relation:e.edge.relation,depth:e.depth,implied:e.edge.implied,impliedFrom:e.edge.impliedFrom,parent:e.parent,traversalPath:e.traversalPath,properties:e.properties,displayProperties:[],visualDirection:e.visualDirection,hasFilteredAncestor:!1,children:[]};return r===!0?(i.depth=1,i.children=[],this.flatResults.push(i)):typeof r=="number"&&e.depth>=r?(i.children=[],this.flatResults.push(i),this.flattenChildren(t)):i.children=t,i}flattenChildren(e){for(let t of e){let r={...t,children:[]};this.flatResults.push(r),this.flattenChildren(t.children)}}addWarning(e){this.warnings.push({message:e})}getResult(e){let{flattenFrom:t}=this.output;return t===!0?{nodes:this.flatResults,warnings:this.warnings}:typeof t=="number"?{nodes:e,warnings:this.warnings}:{nodes:e,warnings:this.warnings}}},Er=class{constructor(e){this.results=[];this.warnings=[];this.visited=new Set([e]),this.startPath=e}hasVisited(e){return this.visited.has(e)}markVisited(e){this.visited.add(e)}addResult(e){this.results.push(e)}addWarning(e){this.warnings.push({message:e})}getStartPath(){return this.startPath}getResult(){return{nodes:this.results,warnings:this.warnings}}};function lt(o,e){let{flattenFrom:t}=e.output;return t===!0?Kn(o,e):Un(o,e)}function Un(o,e){let t=new br(e),r=ci(o,e,t,1);return t.getResult(r)}function ci(o,e,t,r){if(r>e.maxDepth)return[];let i=t.currentPath(),n=o.getOutgoingEdges(i,e.relation),s=[];for(let a of n){if(t.isAncestor(a.toPath))continue;let l=Hn(o,e,t,a,r);l&&s.push(l)}if(n.length===0&&e.onLeaf&&t.getTraversalPath().length>1){let a=Yn(o,e,t,r);s.push(...a)}return s}function Hn(o,e,t,r,i){let n=o.getProperties(r.toPath),s=o.getVisualDirection(r.relation),a=t.buildNodeContext(r,i,n,s),l=e.filter.evaluate(a);if(!l.include&&!l.traverse)return null;t.enterNode(r.toPath);let c=[];if(l.traverse&&i<e.maxDepth&&(c=ci(o,e,t,i+1)),c.length===0&&e.onLeaf){let d=e.onLeaf.handle(a);c.push(...d)}return t.exitNode(),l.include?t.buildResultNode(a,c):null}function Yn(o,e,t,r){var c,m,d;if(!e.onLeaf)return[];let i=t.currentPath(),n=o.getProperties(i),s=o.getVisualDirection(e.relation),a={depth:r,relation:e.relation,isImplied:!1,parent:(c=t.getTraversalPath()[t.getTraversalPath().length-2])!=null?c:null,path:t.getTraversalPath()},l={path:i,edge:{fromPath:(m=a.parent)!=null?m:i,toPath:i,relation:e.relation,implied:!1},depth:r,parent:(d=a.parent)!=null?d:i,traversalPath:t.getTraversalPath(),properties:n,traversalCtx:a,visualDirection:s};return e.onLeaf.handle(l)}function Kn(o,e){var s;let t=new Er(e.startPath),r=[],i=[],n=o.getOutgoingEdges(e.startPath,e.relation);for(let a of n)t.hasVisited(a.toPath)||(t.markVisited(a.toPath),r.push({path:a.toPath,depth:1,parent:e.startPath,traversalPath:[e.startPath,a.toPath]}));for(;r.length>0;){let a=r.shift(),{path:l,depth:c,parent:m,traversalPath:d}=a,f=o.getProperties(l),y=(s=o.getOutgoingEdges(m,e.relation).find(D=>D.toPath===l))!=null?s:{fromPath:m,toPath:l,relation:e.relation,implied:!1},N=o.getVisualDirection(e.relation),C={depth:1,relation:e.relation,isImplied:y.implied,parent:m,path:d},R={path:l,edge:y,depth:1,parent:m,traversalPath:d,properties:f,traversalCtx:C,visualDirection:N},k=e.filter.evaluate(R);if(!k.include&&!k.traverse)continue;k.include&&t.addResult({path:l,relation:e.relation,depth:1,implied:y.implied,impliedFrom:y.impliedFrom,parent:e.startPath,traversalPath:d,properties:f,displayProperties:[],visualDirection:N,hasFilteredAncestor:!1,children:[]});let q=!1;if(k.traverse&&c<e.maxDepth){let D=o.getOutgoingEdges(l,e.relation);for(let L of D)t.hasVisited(L.toPath)||(q=!0,t.markVisited(L.toPath),r.push({path:L.toPath,depth:c+1,parent:l,traversalPath:[...d,L.toPath]}))}!q&&e.onLeaf&&i.push(R)}if(e.onLeaf&&i.length>0)for(let a of i){let l=e.onLeaf.handle(a);for(let c of l)t.addResult(c)}return t.getResult()}function Sr(o,e){return{handle(t){return Zn(o,t.path,e.chain,new Set(t.traversalPath),t.traversalPath,e.filter,e.resolveGroup)}}}function Zn(o,e,t,r,i,n,s){let a=[];for(let l of t)if(l.type==="relation"){let c={startPath:e,relation:l.spec.name,maxDepth:l.spec.depth==="unlimited"?1/0:l.spec.depth,filter:n,output:{flattenFrom:l.spec.flatten},onLeaf:t.length>1?Sr(o,{chain:t.slice(1),filter:n,resolveGroup:s}):void 0},m=lt(o,c);a.push(...m.nodes)}else if(l.type==="group"){if(!s)continue;let c=s(l.name);if(!c)continue;for(let m of c){let d={startPath:e,relation:m.relation,maxDepth:m.maxDepth,filter:n,output:{flattenFrom:m.flatten},onLeaf:t.length>1?Sr(o,{chain:t.slice(1),filter:n,resolveGroup:s}):void 0},f=lt(o,d);a.push(...f.nodes)}}else if(l.type==="inline"){let c=l.query.executeQuery(o);a.push(...c)}return a}function xo(o,e){return t=>{let r=o.resolveGroupQuery(t);if(!r)return;let i=[];for(let n of r.from.chains)i.push({relation:n.first.name,maxDepth:n.first.depth==="unlimited"?1/0:n.first.depth,flatten:n.first.flatten});return i.length>0?i:void 0}}function di(o,e,t){var m;let r=new Map;for(let d of o){let f=(m=e.get(d))!=null?m:[];for(let g of f)if(t.has(g.relation)&&o.has(g.toPath)){r.set(d,g.toPath);break}}if(r.size===0)return{chains:new Map,disconnected:Array.from(o)};let i=new Set(r.values()),n=new Set([...r.keys(),...r.values()]),s=new Map,a=new Set,l=Array.from(n).filter(d=>!i.has(d));if(l.length===0&&n.size>0){let f=Array.from(n).sort((g,y)=>Or(g).localeCompare(Or(y)))[0];f&&l.push(f)}for(let d of l){if(a.has(d))continue;let f=[],g=d;for(;g&&!a.has(g);)f.push(g),a.add(g),g=r.get(g);f.length>0&&s.set(d,f)}let c=Array.from(o).filter(d=>!a.has(d));return{chains:s,disconnected:c}}function Or(o){var r;let e=o.split("/");return((r=e[e.length-1])!=null?r:o).replace(/\.md$/,"")}function Fr(o,e,t){if(o.length<=1)return o.map(s=>({...s,children:Fr(s.children,e,t)}));let r=Jn(o,e,t),i=e.some(s=>s.key==="chain"),n;if(i){let s=t.getSequentialRelations(),a=new Set(o.map(m=>m.path)),l=es(o,t),c=di(a,l,s);n=ts(r,e,c)}else n=[...r].sort((s,a)=>No(s,a,e));return n.map(s=>({...s.node,children:Fr(s.node.children,e,t)}))}function Jn(o,e,t){return o.map(r=>{t.setCurrentFile(r.path,r.properties);let i=e.map(n=>n.key==="chain"?null:n.key.evaluate(t));return{node:r,values:i}})}function es(o,e){let t=new Map;for(let r of o){let i=e.getOutgoingEdges(r.path);t.set(r.path,i)}return t}function ts(o,e,t){let r=new Map(o.map(s=>[s.node.path,s])),i=e.findIndex(s=>s.key==="chain");return i===0||t.chains.size===0?vo(o,e,t,r):rs(o,e,t,r,i)}function vo(o,e,t,r){let i=[];for(let s of t.chains.keys()){let a=r.get(s);a&&i.push(a)}for(let s of t.disconnected){let a=r.get(s);a&&i.push(a)}i.sort((s,a)=>No(s,a,e));let n=[];for(let s of i){let a=t.chains.get(s.node.path);if(a)for(let l of a){let c=r.get(l);c&&n.push(c)}else n.push(s)}return n}function rs(o,e,t,r,i){let n=e.slice(0,i),s=[...o].sort((m,d)=>No(m,d,n));if(n.length===0)return vo(o,e,t,r);let a=is(s,i-1),l=[],c=e.slice(i+1);for(let m of a){if(m.length<=1){l.push(...m);continue}let d=new Set(m.map(g=>g.node.path)),f=os(t,d);if(f.chains.size===0)l.push(...m);else{let g=new Map(m.map(y=>[y.node.path,y]));l.push(...vo(m,c,f,g))}}return l}function os(o,e){let t=new Map,r=[],i=new Set;for(let n of o.chains.values()){let s=n.filter(a=>e.has(a));if(s.length>1){let a=s[0];t.set(a,s),s.forEach(l=>i.add(l))}else s.length===1&&r.push(s[0])}for(let n of o.disconnected)e.has(n)&&r.push(n);for(let n of e)!i.has(n)&&!r.includes(n)&&r.push(n);return{chains:t,disconnected:r}}function is(o,e){let t=new Map,r=[];for(let i of o){let n=i.values[e],s=n==null?"":String(n);t.has(s)||(t.set(s,[]),r.push(s)),t.get(s).push(i)}return r.map(i=>t.get(i))}function No(o,e,t){var r,i;for(let n=0;n<t.length;n++){let s=t[n];if(s.key==="chain")continue;let a=(r=o.values[n])!=null?r:null,l=(i=e.values[n])!=null?i:null,c=ns(a,l);if(s.direction==="desc"&&(c=-c),c!==0)return c}return Or(o.node.path).localeCompare(Or(e.node.path))}function ns(o,e){return o===null&&e===null?0:o===null?1:e===null?-1:typeof o=="number"&&typeof e=="number"?o-e:typeof o=="string"&&typeof e=="string"?o.localeCompare(e):o instanceof Date&&e instanceof Date?o.getTime()-e.getTime():String(o).localeCompare(String(e))}function Wr(o,e){let{from:t,prune:r,where:i,sort:n,startPath:s}=e,a=ss(o,t,r,s!=null?s:o.filePath),l=i?mi(a,i,o):a;return n?Fr(l,n.keys,o):l}function ss(o,e,t,r){let i=[],n=yo(o,{pruneExpr:t==null?void 0:t.expression}),s=xo(o,n);for(let a of e.chains){let l=a.chain.length>0,c={startPath:r,relation:a.first.name,maxDepth:a.first.depth==="unlimited"?1/0:a.first.depth,filter:n,output:{flattenFrom:a.first.flatten},onLeaf:l?Sr(o,{chain:a.chain,filter:n,resolveGroup:s}):void 0},m=lt(o,c);i.push(...m.nodes);for(let d of m.warnings)o.addWarning(d.message)}return i}function mi(o,e,t){let r=[];for(let i of o){t.setCurrentFile(i.path,i.properties),t.setTraversal({depth:i.depth,relation:i.relation,isImplied:i.implied,parent:i.parent,path:i.traversalPath});let n=mi(i.children,e,t);e.test(t)?r.push({...i,children:n}):n.length>0&&r.push(...n.map(s=>({...s,hasFilteredAncestor:!0})))}return r}var te=class extends T{constructor(e,t,r,i,n,s,a,l){super(r),this.group=e,this.from=t,this.prune=i,this.where=n,this.when=s,this.sort=a,this.display=l}validate(e){return this.from.validate(e),this.prune&&this.prune.validate(e),this.where&&this.where.validate(e),this.when&&this.when.validate(e),this.sort&&this.sort.validate(e),this.display&&this.display.validate(e),this}execute(e){if(this.when&&(e.setCurrentFile(e.activeFilePath,e.activeFileProperties),!this.when.test(e)))return{visible:!1,results:[],warnings:e.getWarnings(),errors:e.getErrors()};let t=Wr(e,{from:this.from,prune:this.prune,where:this.where,sort:this.sort,startPath:e.activeFilePath});return{visible:!0,results:this.applyDisplay(t,e),warnings:e.getWarnings(),errors:e.hasErrors()?e.getErrors():void 0}}applyDisplay(e,t){return this.display?e.map(r=>(t.setCurrentFile(r.path,r.properties),{...r,displayProperties:this.evaluateDisplayProperties(r,t),children:this.applyDisplay(r.children,t)})):e}evaluateDisplayProperties(e,t){if(!this.display)return[];let r=[];if(this.display.all)for(let[i,n]of Object.entries(e.properties))i.startsWith("file.")||i.startsWith("traversal.")||r.push({key:i,value:n});for(let i of this.display.properties){let n=i.getFrontmatterPath(),s=n!=null?n:i.path.join("."),a=i.evaluate(t);this.display.all&&n&&r.some(l=>l.key===n)||r.push({key:s,value:a})}return r}};te.providesContexts=["clause"],te.documentation={title:"TQL Query",description:"A complete TQL query with group name, FROM clause, and optional filtering/sorting.",syntax:'group "Name" from ... [prune ...] [where ...] [when ...] [sort ...] [display ...]'},te.completable={keywords:["group"],context:"query-start",priority:100,category:"keyword"},te=u([p("QueryNode",{clause:!0})],te);var re=class extends T{constructor(e,t){super(t),this.chains=e}get relations(){return this.chains.map(e=>e.first)}validate(e){for(let t of this.chains){t.first.validate(e);for(let r of t.chain)r.type==="relation"?r.spec.validate(e):r.type==="group"&&(e.hasGroup(r.name)||e.addError(`Unknown group: ${r.name}`,r.span,"UNKNOWN_GROUP"))}}};re.providesContexts=["relation","clause"],re.documentation={title:"FROM clause",description:"Specifies which relations to traverse. Supports multiple relations with depth, flatten, and chaining modifiers.",syntax:"from Relation [:depth N] [:flatten] [>> Target], ...",examples:["from up","from up, down :depth 2","from up >> next",'from up :depth 2 >> @"Children"']},re.completable={keywords:["from"],context:"after-group-name",priority:100,category:"keyword"},re=u([p("FromNode",{clause:!0})],re);var ae=class extends T{constructor(e,t,r,i){super(r),this.name=e,this.depth=t,this.flatten=i}validate(e){e.hasRelation(this.name)||e.addError(`Unknown relation: ${this.name}`,this.span,"UNKNOWN_RELATION")}};ae.providesContexts=["after-relation"],ae.documentation={title:"Relation Specification",description:"Specifies a relation to traverse with optional depth and flatten modifiers. Use 'flatten' to flatten all, or 'flatten N' to flatten from depth N. If depth is omitted, traversal is unlimited.",syntax:"relation [:depth N] [:flatten [N]]",examples:["up :depth 3","down","same :flatten","down :depth 5 :flatten 2"]},ae=u([p("RelationSpecNode",{clause:!0})],ae);var le=class extends T{constructor(e,t){super(t),this.expression=e}validate(e){this.expression.validate(e)}test(e){let t=this.expression.evaluate(e);return e.isTruthy(t)}};le.providesContexts=["expression","clause"],le.documentation={title:"PRUNE clause",description:"Stops traversal at nodes matching the expression. Matching nodes and their subtrees are not visited.",syntax:"prune Expression",examples:['prune status = "archived"','prune hasTag("private")',"prune traversal.depth > 5"]},le.completable={keywords:["prune"],context:"clause",priority:50,category:"keyword"},le=u([p("PruneNode",{clause:!0})],le);var pe=class extends T{constructor(e,t){super(t),this.expression=e}validate(e){this.expression.validate(e)}test(e){let t=this.expression.evaluate(e);return e.isTruthy(t)}};pe.providesContexts=["expression","clause"],pe.documentation={title:"WHERE clause",description:"Filters results after traversal. Non-matching nodes are hidden but their children may still appear with a gap indicator.",syntax:"where Expression",examples:["where priority >= 3",'where status != "archived"','where hasTag("active") and exists(due)']},pe.completable={keywords:["where"],context:"clause",priority:80,category:"keyword"},pe=u([p("WhereNode",{clause:!0})],pe);var ue=class extends T{constructor(e,t){super(t),this.expression=e}validate(e){this.expression.validate(e)}test(e){let t=this.expression.evaluate(e);return e.isTruthy(t)}};ue.providesContexts=["expression","clause"],ue.documentation={title:"WHEN clause",description:"Conditional visibility for the entire group. If the active file doesn't match, the group is hidden.",syntax:"when Expression",examples:['when type = "project"','when hasTag("daily")','when file.folder = "Projects"']},ue.completable={keywords:["when"],context:"clause",priority:70,category:"keyword"},ue=u([p("WhenNode",{clause:!0})],ue);var oe=class extends T{constructor(e,t){super(t),this.keys=e}validate(e){for(let t of this.keys)t.validate(e)}};oe.providesContexts=["sort-key","clause"],oe.documentation={title:"SORT clause",description:"Orders results by property or :chain position. Multiple sort keys are comma-separated.",syntax:"sort Key [:asc|:desc], ...",examples:["sort date :desc","sort :chain, priority :desc","sort $file.modified :desc, $file.name"]},oe.completable={keywords:["sort"],context:"clause",priority:60,category:"keyword"},oe=u([p("SortNode",{clause:!0})],oe);var ce=class extends T{constructor(e,t,r){super(r),this.key=e,this.direction=t}validate(e){this.key!=="chain"&&this.key.validate(e)}};ce.providesContexts=["sort-key-modifier"],ce.documentation={title:"Sort Key",description:"Specifies a property or :chain to sort by, with optional direction. Use :chain to maintain graph traversal order.",syntax:"property [:asc|:desc] | :chain [:asc|:desc]",examples:["date :desc",":chain","priority :asc","$file.modified :desc"]},ce=u([p("SortKeyNode",{clause:!0})],ce);var ie=class extends T{constructor(e,t,r){super(r),this.all=e,this.properties=t}validate(e){for(let t of this.properties)t.validate(e)}};ie.providesContexts=["display","clause"],ie.documentation={title:"DISPLAY clause",description:"Specifies which properties to show in the Trail pane UI.",syntax:"display Property, ... | all [, Property, ...]",examples:["display status, priority","display all","display all, file.modified"]},ie.completable={keywords:["display"],context:"clause",priority:40,category:"keyword"},ie=u([p("DisplayNode",{clause:!0})],ie);var pt=class extends Error{constructor(t,r){super(t);this.span=r;this.name=this.constructor.name}format(t){var c,m;if(!this.span)return this.message;let r=t.split(`
`),i=0,n=0,s=0;for(let d=0;d<r.length;d++){let g=((c=r[d])!=null?c:"").length+1;if(i+g>this.span.start){n=d+1,s=this.span.start-i+1;break}i+=g}let a=(m=r[n-1])!=null?m:"",l=" ".repeat(s-1)+"^".repeat(Math.max(1,this.span.end-this.span.start));return`${this.message} at line ${n}, column ${s}

  ${a}
  ${l}`}},H=class extends pt{constructor(t,r,i){super(t,r);this.expected=i}};var F=class extends E{constructor(e,t,r){super(r),this.left=e,this.right=t}validate(e){this.left.validate(e),this.right.validate(e)}};var Y=class extends F{constructor(e,t,r){super(e,t,r)}evaluate(e){return e.isTruthy(this.left.evaluate(e))?!0:e.isTruthy(this.right.evaluate(e))}};Y.providesContexts=["after-expression"],Y.documentation={title:"Logical OR Operator",description:"Combines conditions with OR. Requires at least one to be true.",syntax:"expr OR expr",examples:['type = "note" or type = "project"']},Y.highlighting="operatorKeyword",Y.completable={keywords:["or"],context:"after-expression",priority:90,category:"operator"},Y=u([p("OrExprNode",{expr:!0})],Y);var K=class extends F{constructor(e,t,r){super(e,t,r)}evaluate(e){return e.isTruthy(this.left.evaluate(e))?e.isTruthy(this.right.evaluate(e)):!1}};K.providesContexts=["after-expression"],K.documentation={title:"Logical AND Operator",description:"Combines conditions with AND. Requires both to be true.",syntax:"expr AND expr",examples:['status = "active" and priority > 3']},K.highlighting="operatorKeyword",K.completable={keywords:["and"],context:"after-expression",priority:90,category:"operator"},K=u([p("AndExprNode",{expr:!0})],K);var G=class extends F{constructor(e,t,r,i){super(t,r,i),this.op=e}evaluate(e){let t=this.left.evaluate(e),r=this.right.evaluate(e);if(this.op==="=?")return t===null?!1:e.equals(t,r);if(this.op==="!=?")return t===null?!0:!e.equals(t,r);if(this.op==="="||this.op==="!=")return r===null?this.op==="="?t===null:t!==null:t===null?this.op==="="?r===null:r!==null:this.op==="="?e.equals(t,r):!e.equals(t,r);if(t===null||r===null)return null;switch(this.op){case"<":return e.compare(t,r)<0;case">":return e.compare(t,r)>0;case"<=":return e.compare(t,r)<=0;case">=":return e.compare(t,r)>=0}return null}};G.providesContexts=["after-expression"],G.documentation={title:"Comparison Operator",description:"Compares two values. Supports equality, inequality, and ordering. Use =? and !=? for null-safe comparisons.",syntax:"expr op expr",examples:['status = "active"',"priority > 3",'status !=? "archived"']},G.highlighting="operator",G=u([p("CompareExprNode",{expr:!0})],G);var ne=class extends F{constructor(e,t,r,i){super(t,r,i),this.op=e}evaluate(e){let t=this.left.evaluate(e),r=this.right.evaluate(e);if(t===null||r===null)return null;if(t instanceof Date&&typeof r=="number"){let i=this.op==="+"?t.getTime()+r:t.getTime()-r;return new Date(i)}return typeof t=="number"&&typeof r=="number"?this.op==="+"?t+r:t-r:typeof t=="string"&&this.op==="+"?t+String(r):(e.addError(`Cannot perform ${this.op} on ${typeof t} and ${typeof r}`,this.span),null)}};ne.providesContexts=["after-expression"],ne.documentation={title:"Arithmetic Operator",description:"Addition or subtraction. Works with numbers, dates + durations, and string concatenation.",syntax:"expr + expr | expr - expr",examples:["priority + 1","today - 7d",'name + " suffix"']},ne.highlighting="operator",ne=u([p("ArithExprNode",{expr:!0})],ne);var bt=class extends E{constructor(e,t){super(t),this.operand=e}validate(e){this.operand.validate(e)}};var Z=class extends bt{constructor(e,t){super(e,t)}evaluate(e){let t=this.operand.evaluate(e);return!e.isTruthy(t)}};Z.providesContexts=["expression"],Z.documentation={title:"NOT operator",description:"Logical NOT. Inverts the condition. Can also use '!' prefix.",syntax:"not Expr | !Expr",examples:['not status = "archived"','!hasTag("private")']},Z.highlighting="operatorKeyword",Z.completable={keywords:["not"],context:"expression",priority:80,category:"operator"},Z=u([p("NotExprNode",{expr:!0})],Z);var J=class extends E{constructor(e,t,r){super(r),this.value=e,this.collection=t}evaluate(e){let t=this.value.evaluate(e),r=this.collection.evaluate(e);return r===null?!1:Array.isArray(r)?r.some(i=>e.equals(t,i)):typeof r=="string"&&typeof t=="string"?r.includes(t):!1}validate(e){this.value.validate(e),this.collection.validate(e)}};J.providesContexts=["after-expression"],J.documentation={title:"IN operator",description:"Checks membership in array, substring in string, or value in range.",syntax:"Value in Collection | Value in Lower..Upper",examples:['"tag" in tags','"sub" in title',"priority in 1..5","date in 2024-01-01..today"]},J.highlighting="operatorKeyword",J.completable={keywords:["in"],context:"after-expression",priority:85,category:"operator"},J=u([p("InExprNode",{expr:!0})],J);var de=class extends E{constructor(e,t,r,i){super(i),this.value=e,this.lower=t,this.upper=r}evaluate(e){let t=this.value.evaluate(e),r=this.lower.evaluate(e),i=this.upper.evaluate(e);return t===null||r===null||i===null?null:e.compare(t,r)>=0&&e.compare(t,i)<=0}validate(e){this.value.validate(e),this.lower.validate(e),this.upper.validate(e)}};de.documentation={title:"Range Expression",description:"Checks if value is within a range (inclusive on both ends).",syntax:"value in lower..upper",examples:["priority in 1..5","date in startOfWeek..endOfWeek"]},de.highlighting="operator",de=u([p("RangeNode",{expr:!0})],de);var A=class extends E{constructor(e,t,r=!1){super(t),this.path=e,this.isBuiltin=r}getFrontmatterPath(){if(this.isBuiltin){if(this.path[0]==="file"&&this.path[1]==="properties"){let e=this.path.slice(2);return e.length>0?e.join("."):null}return null}return this.path.join(".")}isFileMetadata(){return this.isBuiltin&&this.path[0]==="file"&&this.path[1]!=="properties"}evaluate(e){if(this.isBuiltin){if(this.path[0]==="traversal"&&this.path[1])return e.getTraversalProperty(this.path[1]);if(this.path[0]==="file"){if(this.path[1]==="properties"){let t=this.path.slice(2);return t.length===0?e.properties:e.getPropertyValue(t.join("."))}if(this.path[1])return e.getFileProperty(this.path[1])}return null}return e.getPropertyValue(this.path.join("."))}validate(e){var t;this.path.length===0&&e.addError("Empty property path",this.span,"TYPE_MISMATCH"),this.isBuiltin&&(["file","traversal"].includes((t=this.path[0])!=null?t:"")||e.addError(`Unknown built-in namespace: $${this.path[0]}. Valid namespaces: $file, $traversal`,this.span,"TYPE_MISMATCH"))}};A.documentation={title:"Property Access",description:"Access frontmatter properties directly by name, with dot notation for nested YAML. Use $file.* for file metadata (name, path, created). Use $traversal.* for traversal context.",syntax:"property | nested.path | $file.name | $traversal.depth",examples:["status","obsidian.icon","$file.name","$traversal.depth"]},A.highlighting="variable",A=u([p("PropertyNode",{expr:!0})],A);var me=class extends E{constructor(e,t,r,i,n){super(r),this.func=e,this.source=t,this.property=i,this.condition=n}evaluate(e){let t=this.executeSubquery(e),r=this.flattenTree(t);switch(this.func){case"count":return r.length;case"sum":return this.computeSum(r,e);case"avg":return this.computeAvg(r,e);case"min":return this.computeMin(r,e);case"max":return this.computeMax(r,e);case"any":return this.computeAny(r,e);case"all":return this.computeAll(r,e)}}executeSubquery(e){if(this.source.type==="inlineQuery")return this.source.node.executeQuery(e);let t=e.filePath,r=this.resolveSourceRelations(e),i=[];for(let n of r){let s={startPath:t,relation:n.name,maxDepth:n.depth==="unlimited"?1/0:n.depth,filter:ho,output:{flattenFrom:n.flatten}},a=lt(e,s);i.push(...a.nodes)}return i}resolveSourceRelations(e){var t;if(this.source.type==="groupRef"){let r=e.resolveGroupQuery(this.source.name);return(t=r==null?void 0:r.from.relations)!=null?t:[]}else if(this.source.type==="bareIdentifier"){let r=e.resolveGroupQuery(this.source.name);return r?r.from.relations:[{name:this.source.name,depth:"unlimited"}]}else return[]}flattenTree(e){let t=[];for(let r of e)t.push(r),t.push(...this.flattenTree(r.children));return t}computeSum(e,t){let r=0;for(let i of e){let n=this.getPropertyValue(i,t);typeof n=="number"&&(r+=n)}return r}computeAvg(e,t){let r=0,i=0;for(let n of e){let s=this.getPropertyValue(n,t);typeof s=="number"&&(r+=s,i++)}return i>0?r/i:null}computeMin(e,t){let r=null;for(let i of e){let n=this.getPropertyValue(i,t);n!==null&&(r===null||t.compare(n,r)<0)&&(r=n)}return r}computeMax(e,t){let r=null;for(let i of e){let n=this.getPropertyValue(i,t);n!==null&&(r===null||t.compare(n,r)>0)&&(r=n)}return r}computeAny(e,t){for(let r of e){t.setCurrentFile(r.path,r.properties),t.setTraversal({depth:r.depth,relation:r.relation,isImplied:r.implied,parent:r.parent,path:r.traversalPath});let i=this.condition.evaluate(t);if(t.isTruthy(i))return!0}return!1}computeAll(e,t){if(e.length===0)return!0;for(let r of e){t.setCurrentFile(r.path,r.properties),t.setTraversal({depth:r.depth,relation:r.relation,isImplied:r.implied,parent:r.parent,path:r.traversalPath});let i=this.condition.evaluate(t);if(!t.isTruthy(i))return!1}return!0}getPropertyValue(e,t){return this.property?(t.setCurrentFile(e.path,e.properties),t.setTraversal({depth:e.depth,relation:e.relation,isImplied:e.implied,parent:e.parent,path:e.traversalPath}),this.property instanceof A?t.getPropertyValue(this.property.path.join(".")):this.property.evaluate(t)):null}validate(e){if(this.source.type==="groupRef")e.hasGroup(this.source.name)||e.addError(`Unknown group: ${this.source.name}`,this.source.span,"UNKNOWN_GROUP");else if(this.source.type==="inlineQuery")this.source.node.validate(e);else if(this.source.type==="bareIdentifier"){let i=this.source.name,n=e.hasGroup(i),s=e.hasRelation(i);n&&s?e.addError(`"${i}" is both a group and a relation. Use @"${i}" or @(from ${i}) to disambiguate.`,this.source.span,"AMBIGUOUS_IDENTIFIER"):!n&&!s&&e.addError(`Unknown group or relation: ${i}`,this.source.span,"UNKNOWN_IDENTIFIER")}this.property&&this.property.validate(e),this.condition&&this.condition.validate(e);let t=["sum","avg","min","max"].includes(this.func),r=["any","all"].includes(this.func);t&&!this.property&&e.addError(`${this.func}() requires a property argument`,this.span,"INVALID_ARITY"),r&&!this.condition&&e.addError(`${this.func}() requires a condition argument`,this.span,"INVALID_ARITY")}};me.documentation={title:"Aggregate Function",description:"Computes aggregate values over traversal results. count, sum, avg, min, max operate on values; any, all test conditions.",syntax:"func(source[, property|condition])",examples:["count(children)","sum(@(from tasks), points)",'any(@(from subtasks), status = "done")','all(@"Tasks", priority > 0)']},me.highlighting="function",me=u([p("AggregateNode",{expr:!0})],me);var fe=class extends E{constructor(e,t,r){super(t),this.base=e,this.offset=r}evaluate(e){let t;if(this.base.type==="relativeDate")t=e.resolveRelativeDate(this.base.kind);else if(this.base.type==="dateLiteral")t=this.base.value;else if(this.base.type==="property")t=this.base.node.evaluate(e);else return null;if(!this.offset||!(t instanceof Date))return t;let r=e.durationToMs(this.offset.value,this.offset.unit),i=this.offset.op==="+"?t.getTime()+r:t.getTime()-r;return new Date(i)}validate(e){this.base.type==="property"&&this.base.node.validate(e)}};fe.documentation={title:"Date Expression",description:"A date value with optional arithmetic offset.",syntax:"date [+|- duration]",examples:["today","today - 7d","tomorrow + 1w","file.created - 30d"]},fe.highlighting="atom",fe=u([p("DateExprNode",{expr:!0})],fe);var xe=class extends E{constructor(e,t,r,i,n){super(t),this.from=e,this.prune=r,this.where=i,this.sort=n}evaluate(e){let t=this.executeQuery(e);return this.flattenPaths(t)}executeQuery(e){return Wr(e,{from:this.from,prune:this.prune,where:this.where,sort:this.sort,startPath:e.filePath})}flattenPaths(e){let t=[];for(let r of e)t.push(r.path),t.push(...this.flattenPaths(r.children));return t}validate(e){this.from.validate(e),this.prune&&this.prune.validate(e),this.where&&this.where.validate(e),this.sort&&this.sort.validate(e)}};xe.documentation={title:"Inline Query",description:"Executes a query recursively from the current file context. Used as a source for aggregate functions.",syntax:"@(from relation [prune ...] [where ...] [sort ...])",examples:["count(@(from down))",'count(@(from down where status = "done"))',"sum(@(from tasks depth 1), points)"]},xe.highlighting="keyword",xe=u([p("InlineQueryNode",{expr:!0})],xe);var $=class extends E{constructor(e,t){super(t),this.value=e}evaluate(e){return this.value}validate(e){}};var W=class extends ${constructor(e,t){super(e,t)}};W.documentation={title:"String Literal",description:'A string value enclosed in double quotes. Supports escape sequences: \\\\ \\" \\n \\t',syntax:'"text"',examples:['"active"','"Project Name"','"line1\\nline2"']},W.highlighting="string",W=u([p("StringNode")],W);var _=class extends ${constructor(e,t){super(e,t)}};_.documentation={title:"Number Literal",description:"A numeric value. Supports integers and decimals.",syntax:"123 | 45.67",examples:["5","3.14","100"]},_.highlighting="number",_=u([p("NumberNode")],_);var z=class extends ${constructor(e,t){super(e,t)}};z.documentation={title:"Boolean Literal",description:"A boolean value: true or false.",syntax:"true | false",examples:["true","false"]},z.highlighting="atom",z=u([p("BooleanNode")],z);var j=class extends ${constructor(e){super(null,e)}};j.documentation={title:"Null Literal",description:"Represents absence of a value. Use with = and != to check for null, or =? and !=? for null-safe comparisons.",syntax:"null",examples:["status = null","status != null","status =? null"]},j.highlighting="atom",j=u([p("NullNode")],j);var ge=class extends E{constructor(e,t,r){super(r),this.value=e,this.unit=t}evaluate(e){return e.durationToMs(this.value,this.unit)}validate(e){}};ge.documentation={title:"Duration Literal",description:"A time duration. Units: d (days), w (weeks), m (months), y (years).",syntax:"Nd | Nw | Nm | Ny",examples:["7d","2w","1m","1y"]},ge.highlighting="number",ge=u([p("DurationNode")],ge);var ut=class extends ${constructor(e,t){super(e,t)}};ut.documentation={title:"Date Literal",description:"An ISO-format date. Can include time component.",syntax:"YYYY-MM-DD | YYYY-MM-DDTHH:MM:SS",examples:["2024-01-15","2024-06-30T14:30:00"]},ut.highlighting="number",ut=u([p("DateLiteralNode")],ut);var ct=class extends E{constructor(e,t){super(t),this.kind=e}evaluate(e){return e.resolveRelativeDate(this.kind)}validate(e){}};ct.documentation={title:"Relative Date",description:"A date relative to the current day. Resolved at query execution time.",syntax:"today | yesterday | tomorrow | startOfWeek | endOfWeek",examples:["today","yesterday","startOfWeek"]},ct.highlighting="atom",ct=u([p("RelativeDateNode")],ct);function Mi(o,e){let t=o.topNode;return Ps(t,e)}function b(o){return{start:o.from,end:o.to}}function Q(o,e){return e.slice(o.from,o.to)}function w(o,e){let t=o.cursor();if(!t.firstChild())return null;do if(t.type.id===e)return t.node;while(t.nextSibling());return null}function er(o,e){let t=[],r=o.cursor();if(!r.firstChild())return t;do r.type.id===e&&t.push(r.node);while(r.nextSibling());return t}function I(o){let e=[],t=o.cursor();if(!t.firstChild())return e;do e.push(t.node);while(t.nextSibling());return e}function Ps(o,e){let t=se(o,3,4,"group",!0),r=se(o,3,8,"from",!0),i=se(o,3,23,"prune",!1),n=se(o,3,75,"where",!1),s=se(o,3,82,"when",!1),a=se(o,3,77,"sort",!1),l=se(o,3,84,"display",!1),c=ks(t,e),m=Ii(r,e),d=i?Xi(i,e):void 0,f=n?Bi(n,e):void 0,g=s?Qs(s,e):void 0,y=a?$i(a,e):void 0,N=l?As(l,e):void 0;return new te(c,m,b(o),d,f,g,y,N)}function ks(o,e){let t=w(o,7);if(!t)throw new Error("Missing group name string");return tr(Q(t,e))}function Ii(o,e){let t=er(o,10),r=[];for(let i of t){let n=w(i,11);if(!n)throw new Error("Missing relation spec in chain");let s=Ni(n,e),a=er(i,15),l=[];for(let c of a){let m=w(c,11),d=w(c,16),f=w(c,19);if(m){let g=Ni(m,e);l.push({type:"relation",spec:g})}else if(d){let g=w(d,7);if(!g)throw new Error("Missing string in group reference");let y=tr(Q(g,e));l.push({type:"group",name:y,span:b(c)})}else if(f){let g=Po(f,e);l.push({type:"inline",query:g})}}r.push({first:s,chain:l})}return new re(r,b(o))}function Ni(o,e){let t=w(o,5);if(!t)throw new Error("Missing relation name");let r=Q(t,e),i="unlimited",n,s=er(o,12);for(let a of s){let l=Q(a,e).trim();if(l.startsWith(":depth")){let c=w(a,13);c&&(i=parseInt(Q(c,e),10))}else if(l.startsWith(":flatten")){let c=w(a,13);c?n=parseInt(Q(c,e),10):n=!0}}return new ae(r,i,b(o),n)}function Xi(o,e){let t=To(o,e);return new le(t,b(o))}function Bi(o,e){let t=To(o,e);return new pe(t,b(o))}function Qs(o,e){let t=To(o,e);return new ue(t,b(o))}function To(o,e){let t=I(o);for(let r of t)if(he(r))return ee(r,e);throw new Error(`Missing expression in clause: ${o.name}`)}function $i(o,e){let r=er(o,79).map(i=>Vs(i,e));return new oe(r,b(o))}function Vs(o,e){let t=w(o,80);if(!t)throw new Error("Missing sort key expression");let r,i=Q(t,e).trim();if(i===":chain")r="chain";else{let a=w(t,38),l=w(t,42);if(a)r=jr(a,e);else if(l)r=Kr(l,e);else throw new Error(`Invalid sort key expression: ${i}`)}let n="asc",s=w(o,81);if(s){let a=Q(s,e).trim();a===":asc"?n="asc":a===":desc"&&(n="desc")}return new ce(r,n,b(o))}function As(o,e){let t=w(o,86);if(!t)throw new Error("Missing display list");let r=I(t),i=!1,n=[];for(let s of r)if(s.type.id===35)i=!0;else if(s.type.id===87){let a=w(s,38),l=w(s,42);a?n.push(jr(a,e)):l&&n.push(Kr(l,e))}return new ie(i,n,b(o))}function he(o){return[25,26,27,30,31,32,33,19,16,42,38,39,43,49,69,71,7,13,44,46,48].includes(o.type.id)}function ee(o,e){switch(o.type.id){case 25:return Ls(o,e);case 26:return Ms(o,e);case 27:return Is(o,e);case 30:return Xs(o,e);case 31:return qs(o,e);case 32:return Gs(o,e);case 33:return Fs(o,e);case 19:return Po(o,e);case 16:return Hs(o,e);case 42:return Kr(o,e);case 38:return jr(o,e);case 39:return jr(o,e);case 43:return Ys(o,e);case 49:return Js(o,e);case 7:return Ks(o,e);case 13:return Zs(o,e);case 44:return Gi(o,e);case 46:return Ci(o,e);case 48:return wi(o);default:if(o.name==="Boolean")return Ci(o,e);if(o.name==="Null")return wi(o);throw new Error(`Unknown expression type: ${o.name} (${o.type.id})`)}}function Ls(o,e){let t=I(o),r=[];for(let n of t)n.type.id!==74&&r.push(ee(n,e));if(r.length===1)return r[0];let i=r[0];for(let n=1;n<r.length;n++){let s=r[n];i=new Y(i,s,{start:i.span.start,end:s.span.end})}return i}function Ms(o,e){let t=I(o),r=[];for(let n of t)n.type.id!==73&&r.push(ee(n,e));if(r.length===1)return r[0];let i=r[0];for(let n=1;n<r.length;n++){let s=r[n];i=new K(i,s,{start:i.span.start,end:s.span.end})}return i}function Is(o,e){let t=I(o),r=!1,i=null;for(let s of t)s.type.id===28||s.name==="!"?r=!0:i=s;if(!i)throw new Error("Missing operand in not expression");let n=ee(i,e);return r?new Z(n,b(o)):n}function Xs(o,e){let t=I(o),r=[],i=null,n=null;for(let s of t)s.type.id===69?n=s:$s(s.name)?i=s.name:he(s)&&r.push(ee(s,e));if(n)return Bs(r[0],n,e);if(!i){if(r.length===1)return r[0];throw new Error("CompareExpr without operator must have single operand")}if(r.length!==2)throw new Error(`CompareExpr requires 2 operands, got ${r.length}`);return new G(i,r[0],r[1],b(o))}function Bs(o,e,t){let r=I(e),i=null,n=null;for(let s of r)s.type.id===71?n=s:s.type.id!==70&&he(s)&&(i=ee(s,t));if(!i)throw new Error("Missing collection in 'in' expression");if(n){let s=I(n),a=null;for(let l of s)he(l)&&(a=ee(l,t));if(!a)throw new Error("Missing upper bound in range expression");return new de(o,i,a,{start:o.span.start,end:a.span.end})}return new J(o,i,{start:o.span.start,end:i.span.end})}function $s(o){return["=","!=","<",">","<=",">=","=?","!=?"].includes(o)}function qs(o,e){var s;let t=I(o),r=[];for(let a of t)a.name==="+"?r.push({type:"op",op:"+"}):a.name==="-"?r.push({type:"op",op:"-"}):he(a)&&r.push({type:"operand",node:ee(a,e)});if(r.length===1&&((s=r[0])==null?void 0:s.type)==="operand")return r[0].node;let i=null,n=null;for(let a of r)a.type==="operand"?i===null?i=a.node:n&&(i=new ne(n,i,a.node,{start:i.span.start,end:a.node.span.end}),n=null):n=a.op;if(!i)throw new Error("Empty ArithExpr");return i}function Gs(o,e){let t=I(o);for(let r of t)if(he(r))return ee(r,e);throw new Error("Empty parenthesized expression")}function Fs(o,e){var c,m;let t=w(o,34);if(!t)throw new Error("Missing function name");let r=Q(t,e);if(Ws(r))return _s(o,r,e);let i=w(o,36),n=[];if(i){let d=I(i);for(let f of d)he(f)&&n.push(ee(f,e))}let s=ai(r);if(!s)throw new Error(`Unknown function: ${r}`);let a=(c=s.minArity)!=null?c:0,l=(m=s.maxArity)!=null?m:1/0;if(n.length<a)throw new Error(`${r}() requires at least ${a} argument(s), got ${n.length}`);if(n.length>l)throw new Error(`${r}() accepts at most ${l} argument(s), got ${n.length}`);return new s(n,b(o))}function Po(o,e){let t=w(o,21);if(!t)throw new Error("Missing inline query body");let r=se(t,22,8,"from",!0),i=se(t,22,23,"prune",!1),n=se(t,22,75,"where",!1),s=se(t,22,77,"sort",!1),a=Ii(r,e),l=i?Xi(i,e):void 0,c=n?Bi(n,e):void 0,m=s?$i(s,e):void 0;return new xe(a,b(o),l,c,m)}function se(o,e,t,r,i){var a;let s=er(o,e).map(l=>w(l,t)).filter(l=>!!l);if(s.length>1)throw new H(`Duplicate ${r} clause`,b(o));if(s.length===0){if(i)throw new H(`Missing ${r} clause`,b(o));return null}return(a=s[0])!=null?a:null}function Ws(o){return["count","sum","avg","min","max","any","all"].includes(o.toLowerCase())}function _s(o,e,t){let r=w(o,36);if(!r)throw new Error(`${e}() requires arguments`);let i=zs(r);if(!i)throw new Error(`${e}() requires a source argument`);let n=js(i),s,a=null;if(n.type.id===19)s={type:"inlineQuery",node:Po(n,t)},a=Co(r,i);else if(n.type.id===16){let f=w(n,7);if(!f)throw new Error("Missing string in group reference");s={type:"groupRef",name:tr(Q(f,t)),span:b(n)},a=Co(r,i)}else if(n.type.id===42||n.type.id===5){let f;n.type.id===5?f=Q(n,t):f=Kr(n,t).path.join("."),s={type:"bareIdentifier",name:f,span:b(n)},a=Co(r,i)}else throw new Error(`Invalid source in ${e}(): expected @(...), @"Name", or identifier`);let l=["sum","avg","min","max"].includes(e),c=["any","all"].includes(e),m,d;if(a){let f=ee(a,t);l?m=f:c&&(d=f)}return new me(e,s,b(o),m,d)}function zs(o){let e=I(o);for(let t of e)if(he(t))return t;return null}function js(o){let e=[25,26,27,30,31],t=o;for(;e.includes(t.type.id);){let i=I(t).find(n=>he(n));if(!i)break;t=i}return t}function Co(o,e){let t=I(o),r=!1;for(let i of t){if(r&&he(i))return i;(i===e||i.from===e.from&&i.to===e.to)&&(r=!0)}return null}function Kr(o,e){let t=Us(o,e);return new A(t,b(o),!1)}function jr(o,e){let t=w(o,39);if(!t){let a=Q(o,e).slice(1).split(".");return new A(a,b(o),!0)}let r=Q(t,e).slice(1),i=qi(o,e),n=[r,...i];return new A(n,b(o),!0)}function Us(o,e){let t=[],r=w(o,5);return r&&t.push(Q(r,e)),t.push(...qi(o,e)),t}function qi(o,e){let t=[],r=er(o,41);for(let i of r){let n=w(i,5);if(n){t.push(Q(n,e));continue}let s=w(i,7);s&&t.push(tr(Q(s,e)))}return t}function Hs(o,e){let t=w(o,7);if(!t)throw new Error("Missing string in group reference");let r=tr(Q(t,e));return new A(["@group",r],b(o),!1)}function Ys(o,e){let t=I(o);if(t.length===0)throw new Error("Empty SimpleLiteral");let r=t[0];return ee(r,e)}function Ks(o,e){let t=tr(Q(o,e));return new W(t,b(o))}function Zs(o,e){let t=parseFloat(Q(o,e));return new _(t,b(o))}function Gi(o,e){let t=Q(o,e),r=t.match(/^(\d+(?:\.\d+)?)([dwmy])$/);if(!r||!r[1]||!r[2])throw new Error(`Invalid duration: ${t}`);return new ge(parseFloat(r[1]),r[2],b(o))}function Ci(o,e){let t=Q(o,e).toLowerCase()==="true";return new z(t,b(o))}function wi(o){return new j(b(o))}function Js(o,e){let t=w(o,50),r=w(o,58);if(!t)throw new Error("Missing date base");let i=ea(t,e),n=r?ra(r,e):void 0;return new fe(i,b(o),n)}function ea(o,e){let t=w(o,51),r=w(o,52);if(t){let i=Q(t,e);return{type:"dateLiteral",value:new Date(i),span:b(t)}}if(r)return{type:"relativeDate",kind:ta(r),span:b(r)};throw new Error("Invalid date base")}function ta(o){let e=I(o);if(e.length===0)switch(o.type.id){case 53:return"today";case 54:return"yesterday";case 55:return"tomorrow";case 56:return"startOfWeek";case 57:return"endOfWeek"}let t=e[0];if(t)switch(t.type.id){case 53:return"today";case 54:return"yesterday";case 55:return"tomorrow";case 56:return"startOfWeek";case 57:return"endOfWeek"}return"today"}function ra(o,e){let t=I(o),r="+",i=null;for(let n of t)n.name==="+"?r="+":n.name==="-"?r="-":n.type.id===44&&(i=Gi(n,e));if(!i)throw new Error("Missing duration in date offset");return{op:r,value:i.value,unit:i.unit}}function tr(o){o.startsWith('"')&&o.endsWith('"')&&(o=o.slice(1,-1));let e="",t=0;for(;t<o.length;){if(o[t]==="\\")switch(t++,o[t]){case"\\":e+="\\";break;case'"':e+='"';break;case"n":e+=`
`;break;case"t":e+="	";break;default:e+=o[t]}else e+=o[t];t++}return e}function oa(o,e){let t=null;if(e.iterate({enter(s){s.type.isError&&!t&&(t={from:s.from,to:s.to})}}),t===null)return null;let r=t,i={start:r.from,end:r.to},n=o.slice(r.from,Math.min(r.to+10,o.length));return r.from===r.to&&r.from===o.length?new H("Unexpected end of input",i):new H(`Unexpected token: ${n.trim()||"end of input"}`,i)}function V(o){let e=Gr.parse(o),t=oa(o,e);if(t)throw t;return Mi(e,o)}var Ot=class{constructor(e){this._errors=[];this._warnings=[];this._queryCtx=e,this._filePath=e.activeFilePath,this._properties=e.activeFileProperties}setCurrentFile(e,t){this._filePath=e,this._properties=t}setTraversal(e){this._traversal=e}get filePath(){return this._filePath}get properties(){return this._properties}get traversal(){return this._traversal}get activeFilePath(){return this._queryCtx.activeFilePath}get activeFileProperties(){return this._queryCtx.activeFileProperties}addError(e,t){this._errors.push({name:"RuntimeError",message:e,span:t})}addWarning(e){this._warnings.push({message:e})}hasErrors(){return this._errors.length>0}getErrors(){return this._errors}getWarnings(){return this._warnings}clearErrors(){this._errors=[],this._warnings=[]}getOutgoingEdges(e,t){return this._queryCtx.getOutgoingEdges(e,t)}getIncomingEdges(e,t){return this._queryCtx.getIncomingEdges(e,t)}getProperties(e){return this._queryCtx.getProperties(e)}getFileMetadata(e){return this._queryCtx.getFileMetadata(e)}getRelationNames(){return this._queryCtx.getRelationNames()}getVisualDirection(e){return this._queryCtx.getVisualDirection(e)}getSequentialRelations(){return this._queryCtx.getSequentialRelations()}resolveGroupQuery(e){return this._queryCtx.resolveGroupQuery(e)}isTruthy(e){return!(e===null||e===!1||e===0||e===""||Array.isArray(e)&&e.length===0)}compare(e,t){return e===t?0:e===null?1:t===null?-1:typeof e=="number"&&typeof t=="number"?e-t:typeof e=="string"&&typeof t=="string"?e.localeCompare(t):e instanceof Date&&t instanceof Date?e.getTime()-t.getTime():String(e).localeCompare(String(t))}equals(e,t){return e===t?!0:e===null||t===null?!1:e instanceof Date&&t instanceof Date?e.getTime()===t.getTime():Array.isArray(e)&&Array.isArray(t)?e.length!==t.length?!1:e.every((r,i)=>{var n;return this.equals(r,(n=t[i])!=null?n:null)}):e===t}durationToMs(e,t){switch(t){case"d":return e*864e5;case"w":return e*7*864e5;case"m":return e*30*864e5;case"y":return e*365*864e5}}getPropertyValue(e){let t=e.split("."),r=this._properties;for(let i of t){if(r==null)break;if(typeof r=="object"&&r!==null)r=r[i];else{r=void 0;break}}if(r!==void 0)return r===void 0?null:r;if(t.length>1){let i=this._properties[e];if(i!==void 0)return i}return null}getFileProperty(e){let t=this._queryCtx.getFileMetadata(this._filePath);if(!t)return null;switch(e){case"name":return t.name;case"path":return t.path;case"folder":return t.folder;case"created":return t.created;case"modified":return t.modified;case"size":return t.size;case"tags":return t.tags;default:return null}}getTraversalProperty(e){if(!this._traversal)return null;switch(e){case"depth":return this._traversal.depth;case"relation":return this._traversal.relation;case"isImplied":return this._traversal.isImplied;case"parent":return this._traversal.parent;case"path":return this._traversal.path;default:return null}}resolveRelativeDate(e){let t=new Date,r=new Date(t.getFullYear(),t.getMonth(),t.getDate());switch(e){case"today":return r;case"yesterday":return new Date(r.getTime()-24*60*60*1e3);case"tomorrow":return new Date(r.getTime()+24*60*60*1e3);case"startOfWeek":{let i=r.getDay();return new Date(r.getTime()-i*24*60*60*1e3)}case"endOfWeek":{let i=r.getDay();return new Date(r.getTime()+(6-i)*24*60*60*1e3)}default:return r}}},Zr=class{constructor(e,t){this._errors=[];this._relationNames=e,this._relationNamesLower=new Set(e.map(r=>r.toLowerCase())),this._groupNames=new Set(t)}getRelationNames(){return this._relationNames}getGroupNames(){return Array.from(this._groupNames)}hasRelation(e){return this._relationNamesLower.has(e.toLowerCase())}hasGroup(e){return this._groupNames.has(e)}addError(e,t,r){this._errors.push({message:e,span:t,code:r})}hasErrors(){return this._errors.length>0}getErrors(){return this._errors}};function Rt(o,e){return new Zr(o,e)}function Jr(o,e){let t=new Ot(e);return o.execute(t)}var h=class extends U{constructor(e,t){super(t),this.value=e}validate(e){}};var X=class{};var Dt=class extends h{};Dt.keyword="group",Dt.highlighting="keyword",Dt=u([p("GroupToken",{keyword:"group"})],Dt);var Tt=class extends h{};Tt.keyword="from",Tt.highlighting="keyword",Tt=u([p("FromToken",{keyword:"from"})],Tt);var Pt=class extends h{};Pt.keyword="where",Pt.highlighting="keyword",Pt=u([p("WhereToken",{keyword:"where"})],Pt);var kt=class extends h{};kt.keyword="when",kt.highlighting="keyword",kt=u([p("WhenToken",{keyword:"when"})],kt);var Qt=class extends h{};Qt.keyword="prune",Qt.highlighting="keyword",Qt=u([p("PruneToken",{keyword:"prune"})],Qt);var Vt=class extends h{};Vt.keyword="sort",Vt.highlighting="keyword",Vt=u([p("SortToken",{keyword:"sort"})],Vt);var At=class extends h{};At.keyword="display",At.highlighting="keyword",At=u([p("DisplayToken",{keyword:"display"})],At);var Lt=class extends h{};Lt.keyword="depth",Lt.highlighting="typeName",Lt=u([p("DepthToken",{keyword:"depth"})],Lt);var Mt=class extends h{};Mt.keyword="extend",Mt.highlighting="typeName",Mt=u([p("ExtendToken",{keyword:"extend"})],Mt);var It=class extends h{};It.keyword="flatten",It.highlighting="typeName",It=u([p("FlattenToken",{keyword:"flatten"})],It);var Xt=class extends h{};Xt.keyword="asc",Xt.highlighting="typeName",Xt=u([p("AscToken",{keyword:"asc"})],Xt);var Bt=class extends h{};Bt.keyword="desc",Bt.highlighting="typeName",Bt=u([p("DescToken",{keyword:"desc"})],Bt);var $t=class extends h{};$t.keyword="all",$t.highlighting="typeName",$t=u([p("AllToken",{keyword:"all"})],$t);var qt=class extends h{};qt.keyword="and",qt.highlighting="operatorKeyword",qt=u([p("AndToken",{keyword:"and"})],qt);var Gt=class extends h{};Gt.keyword="or",Gt.highlighting="operatorKeyword",Gt=u([p("OrToken",{keyword:"or"})],Gt);var Ft=class extends h{};Ft.keyword="not",Ft.highlighting="operatorKeyword",Ft=u([p("NotToken",{keyword:"not"})],Ft);var Wt=class extends h{};Wt.keyword="in",Wt.highlighting="operatorKeyword",Wt=u([p("InToken",{keyword:"in"})],Wt);var ve=class extends h{};ve.keyword="true",ve.highlighting="atom",ve.documentation={title:"true",description:"Boolean true literal.",examples:["where active = true","prune archived = true"]},ve.completable={keywords:["true"],context:"expression",priority:40,category:"value"},ve=u([p("TrueToken",{keyword:"true"})],ve);var Ne=class extends h{};Ne.keyword="false",Ne.highlighting="atom",Ne.documentation={title:"false",description:"Boolean false literal.",examples:["where active = false","where draft != false"]},Ne.completable={keywords:["false"],context:"expression",priority:40,category:"value"},Ne=u([p("FalseToken",{keyword:"false"})],Ne);var Ce=class extends h{};Ce.keyword="null",Ce.highlighting="atom",Ce.documentation={title:"null",description:"Null value. Use =? and !=? for null-safe comparisons.",examples:["where status != null","where priority =? null"]},Ce.completable={keywords:["null"],context:"expression",priority:40,category:"value"},Ce=u([p("NullToken",{keyword:"null"})],Ce);var we=class extends h{};we.keyword="today",we.highlighting="atom",we.documentation={title:"today",description:"Current date at midnight. Supports arithmetic with durations.",examples:["date = today","date > today - 7d"]},we.completable={keywords:["today"],context:"expression",priority:50,category:"value"},we=u([p("TodayToken",{keyword:"today"})],we);var be=class extends h{};be.keyword="yesterday",be.highlighting="atom",be.documentation={title:"yesterday",description:"Previous day at midnight.",examples:["date = yesterday","created > yesterday"]},be.completable={keywords:["yesterday"],context:"expression",priority:45,category:"value"},be=u([p("YesterdayToken",{keyword:"yesterday"})],be);var Ee=class extends h{};Ee.keyword="tomorrow",Ee.highlighting="atom",Ee.documentation={title:"tomorrow",description:"Next day at midnight.",examples:["due = tomorrow","due < tomorrow + 7d"]},Ee.completable={keywords:["tomorrow"],context:"expression",priority:45,category:"value"},Ee=u([p("TomorrowToken",{keyword:"tomorrow"})],Ee);var Se=class extends h{};Se.keyword="startOfWeek",Se.highlighting="atom",Se.documentation={title:"startOfWeek",description:"First day of the current week (Sunday) at midnight.",examples:["date >= startOfWeek","modified > startOfWeek"]},Se.completable={keywords:["startOfWeek"],context:"expression",priority:35,category:"value"},Se=u([p("StartOfWeekToken",{keyword:"startofweek"})],Se);var Oe=class extends h{};Oe.keyword="endOfWeek",Oe.highlighting="atom",Oe.documentation={title:"endOfWeek",description:"Last day of the current week (Saturday) at midnight.",examples:["due <= endOfWeek"]},Oe.completable={keywords:["endOfWeek"],context:"expression",priority:35,category:"value"},Oe=u([p("EndOfWeekToken",{keyword:"endofweek"})],Oe);var rr=class extends h{};rr.keyword="=",rr.highlighting="operator",rr.documentation={title:"= (equals)",description:"Equality comparison. When comparing with null, checks if value is null.",syntax:"expr = expr",examples:['status = "active"',"priority = 5","value = null"]};var or=class extends h{};or.keyword="!=",or.highlighting="operator",or.documentation={title:"!= (not equals)",description:"Inequality comparison.",syntax:"expr != expr",examples:['status != "archived"',"priority != 0"]};var ir=class extends h{};ir.keyword="<",ir.highlighting="operator",ir.documentation={title:"< (less than)",description:"Less than comparison. Works with numbers, strings, and dates.",syntax:"expr < expr",examples:["priority < 5","date < today"]};var nr=class extends h{};nr.keyword=">",nr.highlighting="operator",nr.documentation={title:"> (greater than)",description:"Greater than comparison. Works with numbers, strings, and dates.",syntax:"expr > expr",examples:["priority > 3","date > yesterday"]};var sr=class extends h{};sr.keyword="<=",sr.highlighting="operator",sr.documentation={title:"<= (less than or equal)",description:"Less than or equal comparison.",syntax:"expr <= expr",examples:["priority <= 5","due <= endOfWeek"]};var ar=class extends h{};ar.keyword=">=",ar.highlighting="operator",ar.documentation={title:">= (greater than or equal)",description:"Greater than or equal comparison.",syntax:"expr >= expr",examples:["priority >= 3","date >= startOfWeek"]};var lr=class extends h{};lr.keyword="=?",lr.highlighting="operator",lr.documentation={title:"=? (null-safe equals)",description:"Null-safe equality. Returns false if left side is null, otherwise compares normally.",syntax:"expr =? expr",examples:['status =? "active"  // false if status is null']};var pr=class extends h{};pr.keyword="!=?",pr.highlighting="operator",pr.documentation={title:"!=? (null-safe not equals)",description:"Null-safe inequality. Returns true if left side is null, otherwise compares normally.",syntax:"expr !=? expr",examples:['status !=? "archived"  // true if status is null']};var ur=class extends h{};ur.keyword="+",ur.highlighting="operator",ur.documentation={title:"+ (plus)",description:"Addition for numbers, concatenation for strings, date + duration arithmetic.",syntax:"expr + expr",examples:["priority + 1","today + 7d",'name + " suffix"']};var cr=class extends h{};cr.keyword="-",cr.highlighting="operator",cr.documentation={title:"- (minus)",description:"Subtraction for numbers, date - duration arithmetic.",syntax:"expr - expr",examples:["priority - 1","today - 7d"]};var dr=class extends h{};dr.keyword="!",dr.highlighting="operator",dr.documentation={title:"! (not)",description:"Logical NOT. Same as 'not' keyword.",syntax:"!expr",examples:['!hasTag("private")',"!active"]};var mr=class extends h{};mr.keyword="..",mr.highlighting="operator",mr.documentation={title:".. (range)",description:"Creates a range for 'in' expressions. Inclusive on both ends.",syntax:"value in lower..upper",examples:["priority in 1..5","date in startOfWeek..endOfWeek"]};var Tr=class extends h{};Tr.keyword="(",Tr.highlighting="punctuation";var Pr=class extends h{};Pr.keyword=")",Pr.highlighting="punctuation";var kr=class extends h{};kr.keyword=",",kr.highlighting="punctuation";var Qr=class extends h{};Qr.keyword=".",Qr.highlighting="punctuation";var ko=class extends h{};ko.highlighting=void 0;var Qo=class extends h{};Qo.highlighting="string";var Vo=class extends h{};Vo.highlighting="number";var Ao=class extends h{};Ao.highlighting="atom";var Lo=class extends h{};Lo.highlighting="number";var Mo=class extends h{};Mo.highlighting="number";var Io=class extends h{};Io.highlighting="variable";var Xo=class extends h{};Xo.highlighting="keyword";var dt=class extends X{};dt.keyword=":asc",dt.highlighting="typeName",dt.documentation={title:":asc",description:"Ascending sort order (A-Z, 0-9, oldest first). This is the default.",examples:["sort priority :asc","sort $file.name :asc"]},dt.completable={keywords:[":asc"],context:"sort-key",priority:50,category:"keyword"},dt=u([p("AscModifier",{modifier:!0})],dt);var mt=class extends X{};mt.keyword=":desc",mt.highlighting="typeName",mt.documentation={title:":desc",description:"Descending sort order (Z-A, 9-0, newest first).",examples:["sort date :desc","sort priority :desc"]},mt.completable={keywords:[":desc"],context:"sort-key",priority:50,category:"keyword"},mt=u([p("DescModifier",{modifier:!0})],mt);var ft=class extends X{};ft.keyword=":chain",ft.highlighting="typeName",ft.documentation={title:":chain",description:"Sort by graph traversal order. Keeps nodes in the order they were discovered during relation traversal. Useful for sequential relations like 'next'.",syntax:"sort :chain [:asc|:desc]",examples:["sort :chain","sort :chain :desc","sort date :asc, :chain"]},ft.completable={keywords:[":chain"],context:"sort-key",priority:60,category:"keyword"},ft=u([p("ChainModifier",{modifier:!0})],ft);var gt=class extends X{};gt.keyword=":depth",gt.highlighting="typeName",gt.documentation={title:":depth",description:"Sets how many levels to traverse for a relation. If omitted, depth is unlimited.",syntax:":depth N",examples:["from up :depth 3","from down :depth 1"]},gt.completable={keywords:[":depth"],context:"after-relation",priority:80,category:"keyword"},gt=u([p("DepthModifier",{modifier:!0})],gt);var ht=class extends X{};ht.keyword=":flatten",ht.highlighting="typeName",ht.documentation={title:":flatten",description:"Output all reachable nodes as a flat list at depth 1, instead of a nested tree structure. Useful for symmetric relations like 'same' that form cliques.",syntax:"Relation [:depth N] :flatten [N]",examples:["from same :flatten","from down :depth 2 :flatten","from down :depth 5 :flatten 2"]},ht.completable={keywords:[":flatten"],context:"after-relation",priority:60,category:"keyword"},ht=u([p("FlattenModifier",{modifier:!0})],ht);var yt=class extends X{};yt.keyword="extend",yt.highlighting="typeName",yt.documentation={title:"extend",description:"At leaf nodes, continue traversal using another group's FROM definition.",syntax:'extend GroupName | extend "Group Name"',examples:["from up extend Children",'from up extend "My Group" depth 5']},yt.completable={keywords:["extend"],context:"after-relation",priority:70,category:"keyword"},yt=u([p("ExtendModifier",{modifier:!0})],yt);var xt=class extends X{};xt.keyword="all",xt.highlighting="typeName",xt.documentation={title:"all",description:"Modifier for aggregate functions to include all nodes.",examples:['all(status = "done")']},xt.completable={keywords:["all"],context:"expression",priority:40,category:"keyword"},xt=u([p("AllModifier",{modifier:!0})],xt);var eo=class{constructor(e){var t,r,i;this.queryCache=new Map,this.resultCache=new Map,this.maxQueryEntries=(t=e==null?void 0:e.maxQueryEntries)!=null?t:100,this.maxResultEntries=(r=e==null?void 0:e.maxResultEntries)!=null?r:50,this.resultTtlMs=(i=e==null?void 0:e.resultTtlMs)!=null?i:5e3}parseQuery(e){let t=this.queryCache.get(e);if(t)return this.queryCache.delete(e),this.queryCache.set(e,t),t.query;let r=V(e);return this.cacheQuery(e,r),r}getResult(e,t){let r=this.resultKey(e,t),i=this.resultCache.get(r);if(!i)return;if(Date.now()-i.timestamp>this.resultTtlMs){this.resultCache.delete(r);return}return this.resultCache.delete(r),this.resultCache.set(r,i),i.result}setResult(e,t,r){let i=this.resultKey(e,t);this.evictResultIfNeeded();let n=new Set;n.add(t),this.collectResultPaths(r.results,n),this.resultCache.set(i,{result:r,filePath:t,includedPaths:n,timestamp:Date.now()})}collectResultPaths(e,t){for(let r of e)t.add(r.path),this.collectResultPaths(r.children,t)}invalidateFile(e){for(let[t,r]of this.resultCache)(r.filePath===e||r.includedPaths.has(e))&&this.resultCache.delete(t)}invalidatePattern(e){for(let[t,r]of this.resultCache)e.test(r.filePath)&&this.resultCache.delete(t)}invalidateAllResults(){this.resultCache.clear()}clear(){this.queryCache.clear(),this.resultCache.clear()}getStats(){return{queryEntries:this.queryCache.size,resultEntries:this.resultCache.size}}cacheQuery(e,t){this.evictQueryIfNeeded(),this.queryCache.set(e,{query:t,timestamp:Date.now()})}evictQueryIfNeeded(){if(this.queryCache.size>=this.maxQueryEntries){let e=this.queryCache.keys().next();!e.done&&e.value&&this.queryCache.delete(e.value)}}evictResultIfNeeded(){if(this.resultCache.size>=this.maxResultEntries){let e=this.resultCache.keys().next();!e.done&&e.value&&this.resultCache.delete(e.value)}}resultKey(e,t){return`${t}::${e}`}},Bo=null;function _t(){return Bo||(Bo=new eo),Bo}var en=require("@codemirror/state"),ye=require("@codemirror/view"),vt=require("@codemirror/commands"),hr=require("@codemirror/autocomplete"),tn=require("@codemirror/language");var gr=require("@codemirror/language"),B=require("@codemirror/view"),_i=require("@codemirror/state");var zi=gr.LRLanguage.define({name:"tql",parser:Gr,languageData:{commentTokens:{line:"//"}}}),zt=B.Decoration.mark({class:"tql-keyword"}),fr=B.Decoration.mark({class:"tql-type"}),to=B.Decoration.mark({class:"tql-logic"}),ia=B.Decoration.mark({class:"tql-string"}),$o=B.Decoration.mark({class:"tql-number"}),jt=B.Decoration.mark({class:"tql-atom"}),na=B.Decoration.mark({class:"tql-operator"}),sa=B.Decoration.mark({class:"tql-function"}),aa=B.Decoration.mark({class:"tql-property"}),qo=B.Decoration.mark({class:"tql-variable"}),la=B.Decoration.mark({class:"tql-punctuation"}),pa=B.Decoration.mark({class:"tql-comment"}),ua=B.Decoration.mark({class:"tql-builtin"}),Fi={group:zt,from:zt,prune:zt,where:zt,when:zt,sort:zt,display:zt,depth:fr,extend:fr,flatten:fr,asc:fr,desc:fr,all:fr,and:to,or:to,not:to,in:to,String:ia,Number:$o,Duration:$o,Boolean:jt,Null:jt,DateLiteral:$o,today:jt,yesterday:jt,tomorrow:jt,startOfWeek:jt,endOfWeek:jt,BuiltinIdentifier:ua,LineComment:pa},ca=new Set(["FunctionCall"]),da=new Set(["PropertyAccess","SortKey"]),ma=new Set(["RelationSpec"]);function Wi(o){let e=new _i.RangeSetBuilder,t=(0,gr.syntaxTree)(o.state);for(let{from:r,to:i}of o.visibleRanges)t.iterate({from:r,to:i,enter(n){let s=fa(n);s&&e.add(n.from,n.to,s)}});return e.finish()}function fa(o){let e=o.name;return Fi[e]?Fi[e]:e==="Identifier"?ga(o):ha(e)?na:ya(e)?la:null}function ga(o){let e=o.parent;if(!e)return qo;if(ca.has(e.name)){let t=e.firstChild;if(t&&t.from===o.from)return sa}if(da.has(e.name))return aa;if(ma.has(e.name)){let t=e.firstChild;if(t&&t.from===o.from)return qo}return qo}function ha(o){return["=","!=","<",">","<=",">=","=?","!=?","+","-","..","!"].includes(o)}function ya(o){return["(",")",",","."].includes(o)}var ji=B.ViewPlugin.fromClass(class{constructor(o){this.decorations=Wi(o)}update(o){(o.docChanged||o.viewportChanged)&&(this.decorations=Wi(o.view))}},{decorations:o=>o.decorations});function Go(){return new gr.LanguageSupport(zi,[ji])}var Ui=require("@codemirror/view"),Fo=Ui.EditorView.theme({"&":{fontSize:"var(--font-ui-small)",fontFamily:"var(--font-monospace)",backgroundColor:"var(--background-primary)",color:"var(--text-normal)",border:"1px solid var(--background-modifier-border)",borderRadius:"var(--radius-s)"},".cm-content":{padding:"var(--size-4-2)",caretColor:"var(--text-normal)",minHeight:"120px"},".cm-line":{padding:"0 var(--size-4-1)"},".cm-cursor":{borderLeftColor:"var(--text-normal)"},"& .cm-content ::selection":{backgroundColor:"var(--text-selection)"},".cm-activeLine":{backgroundColor:"var(--background-secondary)"},".cm-gutters":{backgroundColor:"var(--background-secondary)",color:"var(--text-faint)",border:"none",borderRight:"1px solid var(--background-modifier-border)"},".cm-lineNumbers .cm-gutterElement":{padding:"0 var(--size-4-2)"},".cm-tooltip":{backgroundColor:"var(--background-primary)",border:"1px solid var(--background-modifier-border)",borderRadius:"var(--radius-s)",boxShadow:"var(--shadow-s)"},".cm-tooltip-autocomplete":{"& > ul":{fontFamily:"var(--font-monospace)",fontSize:"var(--font-ui-small)"},"& > ul > li":{padding:"var(--size-4-1) var(--size-4-2)"},"& > ul > li[aria-selected]":{backgroundColor:"var(--background-modifier-hover)",color:"var(--text-normal)"}},".cm-completionLabel":{color:"var(--text-normal)"},".cm-completionDetail":{color:"var(--text-muted)",fontStyle:"italic",marginLeft:"var(--size-4-2)"},".cm-completionIcon":{marginRight:"var(--size-4-1)"},".cm-diagnostic":{padding:"var(--size-4-1) var(--size-4-2)",marginLeft:"0"},".cm-diagnostic-error":{borderLeft:"3px solid var(--text-error)",backgroundColor:"rgba(var(--color-red-rgb), 0.1)"},".cm-diagnostic-warning":{borderLeft:"3px solid var(--text-warning)",backgroundColor:"rgba(var(--color-yellow-rgb), 0.1)"},".cm-lintRange-error":{backgroundImage:"none",textDecoration:"underline wavy var(--text-error)",textUnderlineOffset:"3px"},".cm-lintRange-warning":{backgroundImage:"none",textDecoration:"underline wavy var(--text-warning)",textUnderlineOffset:"3px"},".cm-tooltip-hover":{padding:"var(--size-4-2)",maxWidth:"400px"}},{dark:!1});var Vr=require("@codemirror/autocomplete"),Ki=require("@codemirror/language");function Hi(o){let e=M.getTokenClass(o);return e==null?void 0:e.documentation}function Wo(o){let e=M.getFunctionClass(o);if(e)return e.documentation}function Yi(){let o=new Map,e=M.getAllFunctionClasses();for(let[t,r]of e){let i=r.documentation;i&&o.set(t,i)}return o}function xa(o,e){let t=o.resolveInner(e,-1);for(;t&&t.name==="\u26A0";)t=t.parent;let r=new Set;for(;t&&t.name!=="Query";){let i=M.getProvidedContexts(t.name);if(i!=null&&i.length){for(let n of i)r.add(n);break}t=t.parent}return r.add("clause"),r}function va(o){return o().map(e=>({label:e,type:"variable",detail:"relation"}))}function Na(o,e,t){var s,a,l,c,m;let r=[],i=M.getCompletablesForContext(o),n=new Set;for(let d of i){let f=d.completable;if(!f)continue;let g=(s=f.keywords)==null?void 0:s[0];if(!g||n.has(g))continue;n.add(g);let y=d.documentation,C={label:g,type:(l={keyword:"keyword",operator:"keyword",function:"function",property:"property",value:"constant"}[(a=f.category)!=null?a:"keyword"])!=null?l:"keyword",detail:(c=f.category)!=null?c:"keyword",info:y==null?void 0:y.description};f.snippet&&(C.apply=(0,Vr.snippet)(f.snippet)),r.push(C)}if(o==="relation"){let d=va(e.getRelationNames);r.push(...d)}if(o==="expression"||o==="after-expression"){let d=Yi();for(let[y,N]of d)r.push({label:y,type:"function",detail:(m=N.syntax)!=null?m:`${y}()`,info:N.description,apply:(0,Vr.snippet)(`${y}(\${1})`)});let f=Jt();for(let y of f)r.push({label:y.name,type:"variable",detail:"built-in",info:y.description});let g=wt();for(let y of g)r.push({label:y.name,type:"property",detail:y.type,info:y.description})}if(o==="sort-key"){let d=Jt();for(let g of d)r.push({label:g.name,type:"variable",detail:"built-in",info:g.description});let f=wt();for(let g of f)r.push({label:g.name,type:"property",detail:g.type,info:g.description})}if(o==="display"){let d=Jt();for(let g of d)r.push({label:g.name,type:"variable",detail:"built-in",info:g.description});let f=wt();for(let g of f)r.push({label:g.name,type:"property",detail:g.type,info:g.description})}if(o==="clause"){let d=[{name:"prune",info:"Stop traversal at matching nodes"},{name:"where",info:"Filter results"},{name:"when",info:"Conditional visibility"},{name:"sort",info:"Order results"},{name:"display",info:"Properties to show"}];for(let f of d)t.has(f.name)||r.push({label:f.name,type:"keyword",detail:"clause",info:f.info})}return r}function Ca(o){let e=new Set,t=o.cursor();do{let r=t.name.toLowerCase();["prune","where","when","sort","display"].includes(r)&&e.add(r)}while(t.next());return e}function _o(o){return(0,Vr.autocompletion)({override:[e=>{let t=e.matchBefore(/[:?\w.$]*$/);if(!t)return null;if(t.from===t.to&&!e.explicit){let d=e.pos>0?e.state.doc.sliceString(e.pos-1,e.pos):`
`;if(!/[\s\n]/.test(d)&&e.pos>0)return null}if((e.state.doc.toString().slice(0,e.pos).match(/"/g)||[]).length%2===1)return null;let s=(0,Ki.syntaxTree)(e.state),a=xa(s,e.pos),l=Ca(s.topNode),c=[];for(let d of a)c.push(...Na(d,o,l));if(t.text){let d=t.text.toLowerCase();c=c.filter(f=>f.label.toLowerCase().startsWith(d))}let m=new Set;return c=c.filter(d=>m.has(d.label)?!1:(m.add(d.label),!0)),c.length===0?null:{from:t.from,options:c,validFor:/^[:?\w.$]*$/}}],defaultKeymap:!0,maxRenderedOptions:50,activateOnTyping:!0})}var Zi=require("@codemirror/lint");function zo(){return(0,Zi.linter)(o=>{let e=o.state.doc.toString();if(!e.trim())return[];try{return V(e),[]}catch(t){return t instanceof H&&t.span?[{from:Math.min(t.span.start,e.length),to:Math.min(t.span.end,e.length),severity:"error",message:t.message,source:"TQL"}]:[{from:e.length,to:e.length,severity:"error",message:String(t),source:"TQL"}]}},{delay:300})}var Ji=require("@codemirror/view");function wa(o,e){var i,n;let t=e,r=e;for(;t>0&&/[\w.$]/.test((i=o[t-1])!=null?i:"");)t--;for(;r<o.length&&/[\w.]/.test((n=o[r])!=null?n:"");)r++;return t===r?null:{word:o.slice(t,r),from:t,to:r}}function ba(o){var s,a;let e=o.toLowerCase(),t=Hi(o);if(t)return jo({title:t.title,description:t.description,syntax:t.syntax,examples:t.examples});let r=(s=Wo(o))!=null?s:Wo(e);if(r)return jo({title:(a=r.syntax)!=null?a:r.title,description:r.description,examples:r.examples,extra:r.returnType?`Returns: ${r.returnType}`:void 0});let n=wt().find(l=>l.name===o);return n?jo({title:n.name,description:n.description,extra:`Type: ${n.type}`}):null}function jo(o){let e=document.createElement("div");e.className="tql-hover-tooltip";let t=document.createElement("div");t.className="tql-hover-title",t.textContent=o.title,e.appendChild(t);let r=document.createElement("div");if(r.className="tql-hover-description",r.textContent=o.description,e.appendChild(r),o.syntax){let i=document.createElement("div");i.className="tql-hover-section";let n=document.createElement("div");n.className="tql-hover-label",n.textContent="Syntax",i.appendChild(n);let s=document.createElement("code");s.className="tql-hover-syntax",s.textContent=o.syntax,i.appendChild(s),e.appendChild(i)}if(o.examples&&o.examples.length>0){let i=document.createElement("div");i.className="tql-hover-section";let n=document.createElement("div");n.className="tql-hover-label",n.textContent=o.examples.length===1?"Example":"Examples",i.appendChild(n);let s=document.createElement("div");s.className="tql-hover-examples";for(let a of o.examples){let l=document.createElement("code");l.className="tql-hover-example",l.textContent=a,s.appendChild(l)}i.appendChild(s),e.appendChild(i)}if(o.extra){let i=document.createElement("div");i.className="tql-hover-extra",i.textContent=o.extra,e.appendChild(i)}return e}function Uo(){return(0,Ji.hoverTooltip)((o,e)=>{let t=o.state.doc.toString(),r=wa(t,e);if(!r)return null;let i=ba(r.word);return i?{pos:r.from,end:r.to,above:!0,create:()=>({dom:i})}:null},{hoverTime:300})}function rn(o){var i;let e=[(0,ye.lineNumbers)(),(0,ye.highlightActiveLine)(),(0,vt.history)(),(0,tn.bracketMatching)(),(0,hr.closeBrackets)(),ye.keymap.of([{key:"Enter",run:n=>((0,vt.insertNewlineAndIndent)(n),setTimeout(()=>(0,hr.startCompletion)(n),0),!0)},...vt.defaultKeymap,...vt.historyKeymap,...hr.closeBracketsKeymap]),Go(),Fo,_o({getRelationNames:o.getRelationNames}),zo(),Uo(),ye.EditorView.updateListener.of(n=>{n.docChanged&&o.onChange&&o.onChange(n.state.doc.toString())})];o.minHeight&&e.push(ye.EditorView.theme({".cm-content":{minHeight:o.minHeight}}));let t=en.EditorState.create({doc:(i=o.doc)!=null?i:"",extensions:e});return new ye.EditorView({state:t,parent:o.parent})}function an(o){try{let e=V(o);return ln(e)}catch(e){return!1}}function ln(o){var e,t;return!(!o.group||o.from.relations.length===0||o.prune||o.when&&!on(o.when.expression)||o.where&&!on(o.where.expression)||o.sort&&(o.sort.keys.length>1||((e=o.sort.keys[0])==null?void 0:e.key)==="chain")||(t=o.display)!=null&&t.all)}function on(o){return o instanceof A?!0:!(!(o instanceof G)||!(o.left instanceof A)||!(o.right instanceof W)&&!(o.right instanceof _)&&!(o.right instanceof z)&&!(o.right instanceof j))}function pn(o){var e,t;try{let r=V(o);return ln(r)?{name:r.group,relations:r.from.relations.map(i=>({name:i.name,depth:i.depth})),where:nn((e=r.where)==null?void 0:e.expression),when:nn((t=r.when)==null?void 0:t.expression),sort:Ea(r),display:Sa(r)}:null}catch(r){return null}}function nn(o){if(!o)return;if(o instanceof A)return{property:o.path.join("."),operator:"exists"};if(!(o instanceof G)||!(o.left instanceof A))return;let e=o.left.path.join(".");if(o.right instanceof j)return o.op==="="||o.op==="=?"?{property:e,operator:"notExists"}:o.op==="!="||o.op==="!=?"?{property:e,operator:"exists"}:void 0;let t="=";switch(o.op){case"=":t="=";break;case"!=":t="!=";break;case"<":t="<";break;case">":t=">";break;case"<=":t="<=";break;case">=":t=">=";break;default:return}let r;if(o.right instanceof W)r=o.right.value;else if(o.right instanceof _)r=o.right.value;else if(o.right instanceof z)r=o.right.value;else return;return{property:e,operator:t,value:r}}function Ea(o){if(!o.sort||o.sort.keys.length===0)return;let e=o.sort.keys[0];if(!(!e||e.key==="chain"))return{property:e.key.path.join("."),direction:e.direction}}function Sa(o){if(!(!o.display||o.display.all)&&o.display.properties.length!==0)return o.display.properties.map(e=>e.path.join("."))}function sn(o){let{property:e,operator:t,value:r}=o;if(t==="exists")return e;if(t==="notExists")return`${e} = null`;let i=typeof r=="string"?`"${r}"`:String(r!=null?r:"");return`${e} ${t} ${i}`}function un(o){let e=[];e.push(`group "${o.name}"`);let t=o.relations.map(r=>{let i=r.depth==="unlimited"?"unlimited":r.depth.toString();return`${r.name} depth ${i}`}).join(", ");return e.push(`from ${t}`),o.when&&o.when.property&&e.push(`when ${sn(o.when)}`),o.where&&o.where.property&&e.push(`where ${sn(o.where)}`),o.sort&&e.push(`sort ${o.sort.property} ${o.sort.direction}`),o.display&&o.display.length>0&&e.push(`display ${o.display.join(", ")}`),e.join(`
`)}var Ar=class{constructor(e,t,r){this.plugin=e,this.display=t,this.editorViews=r}cleanup(){for(let e of this.editorViews.values())e.destroy();this.editorViews.clear()}saveOpenState(e){let t=e.querySelectorAll(".trail-group-section"),r=new Set;return t.forEach((i,n)=>{i.open&&r.add(n)}),r}render(e,t){new P.SettingGroup(e).setHeading("Options").addSetting(r=>{r.setName("Hide empty groups").setDesc("Hide groups that have no relations for the current note.").addToggle(i=>{i.setValue(!!this.plugin.settings.hideEmptyGroups).onChange(n=>{this.plugin.settings.hideEmptyGroups=n,this.plugin.saveSettings()})})}).addSetting(r=>{r.setName("Editor mode").setDesc("How to display TQL group editors. Auto shows visual editor for simple queries.").addDropdown(i=>{var n;i.addOption("auto","Auto").addOption("visual","Visual").addOption("query","Query").setValue((n=this.plugin.settings.editorMode)!=null?n:"auto").onChange(s=>{this.plugin.settings.editorMode=s,this.plugin.saveSettings(),this.display()})})}),Ho(this.plugin.settings)&&this.renderMigrationBanner(e),new P.SettingGroup(e).setHeading("TQL groups").addSetting(r=>{r.setDesc("Configure relation groups shown in the trail pane using TQL queries.")});for(let[r,i]of this.plugin.settings.tqlGroups.entries())this.renderTqlGroupSection(e,i,r,t);this.renderAddGroupControl(e,t),Ho(this.plugin.settings)&&this.renderLegacyGroupsSection(e)}renderMigrationBanner(e){let t=e.createDiv({cls:"trail-migration-banner"});new P.Setting(t).setName("Legacy groups detected").setDesc("Your configuration includes legacy groups. Click 'Migrate' on each group below to convert them to TQL format.").setHeading()}renderTqlGroupSection(e,t,r,i){var R,k,q;let{details:n,summary:s,summaryContent:a,content:l}=Nr(e,"trail-relation-section trail-group-section trail-tql-group"),c=i.has(r);n.open=c;let m=(k=(R=this.extractGroupName(t.query))!=null?R:t.name)!=null?k:"(unnamed)",d=a.createEl("span",{cls:"trail-relation-name",text:m});(!m||m==="(unnamed)")&&d.addClass("trail-relation-name-empty");let f=a.createDiv({cls:"trail-relation-badges"});f.createEl("span",{cls:"trail-badge trail-badge-tql",text:"TQL"}),t.enabled===!1&&f.createEl("span",{cls:"trail-badge trail-badge-disabled",text:"disabled"}),vr(s,n,r,this.plugin.settings.tqlGroups,()=>{this.plugin.saveSettings(),this.display()}),new P.Setting(l).setName("Enabled").setDesc("Show this group in the trail pane.").addToggle(D=>{D.setValue(t.enabled!==!1).onChange(L=>{t.enabled=L,this.plugin.saveSettings(),this.display()})});let g=(q=this.plugin.settings.editorMode)!=null?q:"auto",y=an(t.query),N=g==="visual"||g==="auto"&&y,C=l.createDiv({cls:"trail-query-error"});if(N&&y?this.renderVisualEditor(l,t,r,d,C):this.renderQueryEditor(l,t,r,d,C),y||g==="query"){let D=N&&y?"Edit as query":"Edit visually",L=N&&y?"Switch to raw TQL query editor":y?"Switch to visual form editor":"Query is too complex for visual editing";new P.Setting(l).setName(D).setDesc(L).addButton(Pn=>{Pn.setButtonText(N&&y?"Query mode":"Visual mode").setDisabled(!y&&!N).onClick(()=>{let kn=N?"query":"visual";this.plugin.settings.editorMode=kn,this.plugin.saveSettings(),this.display()})})}new P.Setting(l).addButton(D=>{D.setButtonText("Delete group").setWarning().onClick(()=>{this.plugin.settings.tqlGroups.splice(r,1),this.plugin.saveSettings(),this.display()})})}renderQueryEditor(e,t,r,i,n){new P.Setting(e).setName("Query").setDesc("TQL query defining this group.");let s=e.createDiv({cls:"trail-codemirror-container"}),a=rn({doc:t.query,parent:s,onChange:l=>{t.query=l,this.validateQuery(l,n,i),this.plugin.saveSettings()},getRelationNames:()=>this.plugin.settings.relations.map(l=>l.id),minHeight:"120px"});this.editorViews.set(r,a),this.validateQuery(t.query,n,i)}renderVisualEditor(e,t,r,i,n){let s=pn(t.query);if(!s){this.renderQueryEditor(e,t,r,i,n);return}new P.Setting(e).setName("Name").setDesc("Display name for this group.").addText(l=>{l.setValue(s.name).setPlaceholder("Group name").onChange(c=>{s.name=c,this.updateGroupFromVisual(t,s,i,n)})});let a=e.createDiv({cls:"trail-visual-relations"});new P.Setting(a).setName("Relations").setDesc("Relations to traverse.").setHeading();for(let[l,c]of s.relations.entries()){let m=a.createDiv({cls:"trail-visual-relation"});new P.Setting(m).addDropdown(d=>{for(let f of this.plugin.settings.relations)d.addOption(f.id,De(f));d.setValue(c.name).onChange(f=>{c.name=f,this.updateGroupFromVisual(t,s,i,n)})}).addText(d=>{let f=c.depth==="unlimited"?"":String(c.depth);d.setValue(f).setPlaceholder("unlimited").onChange(g=>{if(!g||g.toLowerCase()==="unlimited")c.depth="unlimited";else{let y=parseInt(g,10);c.depth=isNaN(y)?"unlimited":y}this.updateGroupFromVisual(t,s,i,n)}),d.inputEl.addClass("trail-depth-input")}).addExtraButton(d=>{d.setIcon("x").setTooltip("Remove relation").onClick(()=>{s.relations.splice(l,1),s.relations.length===0&&s.relations.push({name:"up",depth:"unlimited"}),this.updateGroupFromVisual(t,s,i,n),this.display()})})}new P.Setting(a).addButton(l=>{l.setButtonText("Add relation").onClick(()=>{s.relations.push({name:"up",depth:"unlimited"}),this.updateGroupFromVisual(t,s,i,n),this.display()})}),this.renderVisualCondition(e,s,t,i,n,{field:"when",title:"Show when",description:"Only show this group when the current note matches this condition (optional).",emptyDescription:"No condition set. Group always visible."}),this.renderVisualCondition(e,s,t,i,n,{field:"where",title:"Filter results",description:"Only include results where this condition is true (optional).",emptyDescription:"No filter set. All results shown."}),new P.Setting(e).setName("Sort by").setDesc("Property to sort results by (optional).").addText(l=>{var c,m;l.setValue((m=(c=s.sort)==null?void 0:c.property)!=null?m:"").setPlaceholder("No sorting").onChange(d=>{var f,g;d?s.sort={property:d,direction:(g=(f=s.sort)==null?void 0:f.direction)!=null?g:"asc"}:s.sort=void 0,this.updateGroupFromVisual(t,s,i,n)})}).addDropdown(l=>{var c,m;l.addOption("asc","Ascending").addOption("desc","Descending").setValue((m=(c=s.sort)==null?void 0:c.direction)!=null?m:"asc").onChange(d=>{s.sort&&(s.sort.direction=d,this.updateGroupFromVisual(t,s,i,n))})}),new P.Setting(e).setName("Display properties").setDesc("Comma-separated list of properties to show (optional).").addText(l=>{var c,m;l.setValue((m=(c=s.display)==null?void 0:c.join(", "))!=null?m:"").setPlaceholder("No extra properties").onChange(d=>{d.trim()?s.display=d.split(",").map(f=>f.trim()).filter(Boolean):s.display=void 0,this.updateGroupFromVisual(t,s,i,n)})})}renderVisualCondition(e,t,r,i,n,s){let a=e.createDiv({cls:`trail-visual-${s.field}`});new P.Setting(a).setName(s.title).setDesc(s.description).setHeading();let l=t[s.field];if(!!l&&l){let m=a.createDiv({cls:"trail-visual-condition"}),d=l.operator==="exists"||l.operator==="notExists";new P.Setting(m).addText(f=>{var g;f.setValue((g=l.property)!=null?g:"").setPlaceholder("Property").onChange(y=>{l.property=y,this.updateGroupFromVisual(r,t,i,n)})}).addDropdown(f=>{var g;f.addOption("exists","exists").addOption("notExists","not exists").addOption("=","=").addOption("!=","!=").addOption("<","<").addOption(">",">").addOption("<=","<=").addOption(">=",">=").addOption("contains","contains").setValue((g=l.operator)!=null?g:"exists").onChange(y=>{l.operator=y,(y==="exists"||y==="notExists")&&(l.value=void 0),this.updateGroupFromVisual(r,t,i,n),this.display()})}).addText(f=>{let g=l.value===void 0?"":String(l.value);f.setValue(g).setPlaceholder("Value").setDisabled(d).onChange(y=>{y==="true"?l.value=!0:y==="false"?l.value=!1:!isNaN(Number(y))&&y.trim()!==""?l.value=Number(y):l.value=y,this.updateGroupFromVisual(r,t,i,n)})}).addExtraButton(f=>{f.setIcon("x").setTooltip("Remove condition").onClick(()=>{s.field==="when"?t.when=void 0:t.where=void 0,this.updateGroupFromVisual(r,t,i,n),this.display()})})}else new P.Setting(a).setDesc(s.emptyDescription).addButton(m=>{m.setButtonText("Add condition").onClick(()=>{let d={property:"type",operator:"exists"};s.field==="when"?t.when=d:t.where=d,this.updateGroupFromVisual(r,t,i,n),this.display()})})}updateGroupFromVisual(e,t,r,i){e.query=un(t),r.textContent=t.name||"(unnamed)",this.validateQuery(e.query,i,r),this.plugin.saveSettings()}validateQuery(e,t,r){t.empty();try{let i=V(e);r.textContent=i.group||"(unnamed)",r.removeClass("trail-relation-name-empty"),t.removeClass("trail-query-error-visible")}catch(i){i instanceof pt?(t.textContent=i.message,t.addClass("trail-query-error-visible")):(t.textContent=String(i),t.addClass("trail-query-error-visible"))}}extractGroupName(e){var t;try{return V(e).group}catch(r){let i=e.match(/group\s+"([^"]+)"/);return(t=i==null?void 0:i[1])!=null?t:null}}renderAddGroupControl(e,t){let r=new P.Setting(e).setName("Add new group").setDesc("Create a TQL group to organize your trail pane."),i="";r.addText(n=>{n.setPlaceholder("E.g., Ancestors, Children, Siblings").onChange(s=>{i=s})}).addButton(n=>{n.setButtonText("Create").setCta().onClick(()=>{var c,m;let s=i.trim();if(!s){new P.Notice("Group name cannot be empty.");return}let a=this.plugin.settings.tqlGroups.length,l=(m=(c=this.plugin.settings.relations[0])==null?void 0:c.id)!=null?m:"up";this.plugin.settings.tqlGroups.push({query:`group "${s}"
from ${l}`,enabled:!0}),t.add(a),this.plugin.saveSettings(),this.display()})})}renderLegacyGroupsSection(e){let t=e.createDiv({cls:"trail-legacy-groups"});new P.Setting(t).setName("Legacy groups").setDesc("These groups use the old format. Migrate them to TQL for full functionality.").setHeading();for(let[r,i]of this.plugin.settings.groups.entries())this.renderLegacyGroupSection(t,i,r)}renderLegacyGroupSection(e,t,r){let i=e.createDiv({cls:"trail-legacy-group-item"}),n=i.createDiv({cls:"trail-legacy-group-header"});n.createSpan({text:t.name||"(unnamed)",cls:"trail-legacy-group-name"});let s=n.createDiv({cls:"trail-legacy-group-actions"});s.createEl("button",{text:"Migrate to TQL",cls:"mod-cta"}).addEventListener("click",()=>{let f=qr(t);this.plugin.settings.tqlGroups.push(f),this.plugin.settings.groups.splice(r,1),this.plugin.saveSettings(),new P.Notice(`Migrated "${t.name}" to TQL`),this.display()}),s.createEl("button",{text:"Delete",cls:"mod-warning"}).addEventListener("click",()=>{this.plugin.settings.groups.splice(r,1),this.plugin.saveSettings(),this.display()});let c=i.createDiv({cls:"trail-legacy-preview"}),m=c.createEl("button",{text:"Show generated TQL"}),d=c.createDiv({cls:"trail-legacy-preview-content trail-hidden"});m.addEventListener("click",()=>{if(d.hasClass("trail-hidden")){let f=qr(t);d.empty(),d.createEl("pre",{text:f.query}),d.removeClass("trail-hidden"),m.textContent="Hide generated TQL"}else d.addClass("trail-hidden"),m.textContent="Show generated TQL"})}};var Lr=class extends cn.PluginSettingTab{constructor(t,r){super(t,r);this.openRelationSections=new Set;this.openGroupSections=new Set;this.editorViews=new Map;this.activeTab="relations";this.plugin=r,this.relationsRenderer=new wr(r,()=>this.display()),this.groupsRenderer=new Ar(r,()=>this.display(),this.editorViews)}display(){let{containerEl:t}=this;this.saveOpenState(t),this.groupsRenderer.cleanup(),t.empty(),t.addClass("trail-settings"),this.renderTabNavigation(t),this.renderTabContent(t)}renderTabNavigation(t){let r=t.createDiv({cls:"trail-settings-tabs"});r.createDiv({cls:`trail-settings-tab ${this.activeTab==="relations"?"is-active":""}`,text:"Relations"}).addEventListener("click",()=>{this.activeTab!=="relations"&&(this.activeTab="relations",this.display())}),r.createDiv({cls:`trail-settings-tab ${this.activeTab==="groups"?"is-active":""}`,text:"Groups"}).addEventListener("click",()=>{this.activeTab!=="groups"&&(this.activeTab="groups",this.display())})}renderTabContent(t){let r=t.createDiv({cls:"trail-settings-content"});this.activeTab==="relations"?this.relationsRenderer.render(r,this.openRelationSections):this.groupsRenderer.render(r,this.openGroupSections)}saveOpenState(t){this.openRelationSections=this.relationsRenderer.saveOpenState(t),this.openGroupSections=this.groupsRenderer.saveOpenState(t)}};var JC={relations:lo(),tqlGroups:po(),groups:[],hideEmptyGroups:!1,editorMode:"auto"};function dn(o){var n,s,a,l,c;let e=o!=null?o:{},t=(n=e.tqlGroups)!=null?n:[],r=(s=e.groups)!=null?s:[],i=(a=e.relations)!=null?a:lo();if(t.length===0&&r.length===0&&(t=po()),r.length>0){let m=ei(r);t=[...t,...m],r=[]}return ri(t),Oa(i),Ta(i),{relations:i,tqlGroups:t,groups:r,hideEmptyGroups:(l=e.hideEmptyGroups)!=null?l:!1,editorMode:(c=e.editorMode)!=null?c:"auto"}}function Ho(o){return o.groups.length>0}function mn(o){if(!o)return!1;if(Array.isArray(o.groups)&&o.groups.length>0)return!0;if(Array.isArray(o.tqlGroups)){for(let e of o.tqlGroups)if(e.query&&co(e.query))return!0}if(Array.isArray(o.relations)){for(let e of o.relations)if(fn(e.aliases)||Da(e))return!0}return!1}function fn(o){return Array.isArray(o)?o.some(e=>e&&typeof e=="object"&&"type"in e):!1}function Oa(o){for(let e of o){if(!fn(e.aliases))continue;let t=[],r=e.aliases;for(let i of r)t.push({key:Ra(i)});e.aliases=t}}function Ra(o){switch(o.type){case"property":return o.key;case"dotProperty":return`"${o.key}"`;case"relationsMap":return`relations.${o.key}`;default:return o.key}}function Da(o){if(!o||typeof o!="object")return!1;let e=o;return"name"in e&&!("id"in e)}function Ta(o){for(let e of o){let t=e;if(t.name!==void 0&&t.id===void 0){let r=t.name.toLowerCase();e.id=r,t.name!==r&&(e.displayName=t.name),delete e.name}}}function De(o){var e;return(e=o.displayName)!=null?e:o.id}var io=require("obsidian");var Pa=/^[a-z0-9][a-z0-9_-]*$/i;function ro(o){return o.trim().toLowerCase()}function Mr(o){return Pa.test(o)}function Nt(o){var r,i;let e=(r=o.split("|")[0])!=null?r:o;return((i=e.split("#")[0])!=null?i:e).trim()}function gn(o){let e=o.match(/\[\[([^\]]+)\]\]/);return!e||!e[1]?o.trim():Nt(e[1])}function oo(o){var r,i;let e=new Set,t=[];for(let n of o){let s=`${(r=n.source)!=null?r:""}::${n.relation}::${(i=n.target)!=null?i:""}`;e.has(s)||(e.add(s),t.push(n))}return t}var ka=/\[\[([^\]]+)\]\]::\s*([a-z0-9][a-z0-9_-]*)\s*::\s*\[\[([^\]]+)\]\]/gi,Qa=/([a-z0-9][a-z0-9_-]*)::\s*\[\[([^\]]+)\]\]/gi,Va=/\[\[([^\]]+)\]\]::\s*([a-z0-9][a-z0-9_-]*)/gi,Aa=/::\s*\[\[([^\]]+)\]\]/gi,La=/::-::\s*\[\[([^\]]+)\]\]/gi;function hn(o,e){let t=[],r=[];Ma(o,r),Ia(o,r),Xa(o,r),$a(o,r),Ba(o,r),r.sort((s,a)=>s.start-a.start);let i=qa(r),n=null;for(let s of i){let a=s.relation?ro(s.relation):null;if(!(a&&(!Mr(a)||e&&!e.has(a))))switch(s.type){case"triple":{let l=s.source?Nt(s.source):void 0,c=s.target?Nt(s.target):void 0;if(!l||!c||!a)continue;t.push({relation:a,target:c,source:l}),n={source:l,relation:a,lastTarget:c};break}case"prefix":{let l=s.target?Nt(s.target):void 0;if(!l||!a)continue;t.push({relation:a,target:l}),n={source:void 0,relation:a,lastTarget:l};break}case"suffix":{let l=s.source?Nt(s.source):void 0;if(!l||!a)continue;i.some(m=>m.start>s.end&&m.type==="continuation"&&!i.some(d=>d.start>s.end&&d.start<m.start&&(d.type==="triple"||d.type==="prefix"||d.type==="suffix")))||t.push({relation:a,source:l}),n={source:l,relation:a,lastTarget:void 0};break}case"continuation":{if(!n)continue;let l=s.target?Nt(s.target):void 0;if(!l)continue;t.push({relation:n.relation,target:l,source:n.source}),n.lastTarget=l;break}case"chain":{if(!n)continue;let l=s.target?Nt(s.target):void 0;if(!l)continue;t.push({relation:n.relation,target:l,source:n.lastTarget}),n.lastTarget=l;break}}}return oo(t)}function Ma(o,e){var t,r;for(let i of o.matchAll(ka))e.push({type:"triple",start:(t=i.index)!=null?t:0,end:((r=i.index)!=null?r:0)+i[0].length,source:i[1],relation:i[2],target:i[3]})}function Ia(o,e){var t,r;for(let i of o.matchAll(Qa))e.push({type:"prefix",start:(t=i.index)!=null?t:0,end:((r=i.index)!=null?r:0)+i[0].length,relation:i[1],target:i[2]})}function Xa(o,e){var t,r;for(let i of o.matchAll(Va))e.push({type:"suffix",start:(t=i.index)!=null?t:0,end:((r=i.index)!=null?r:0)+i[0].length,source:i[1],relation:i[2]})}function Ba(o,e){var t,r;for(let i of o.matchAll(Aa))e.push({type:"continuation",start:(t=i.index)!=null?t:0,end:((r=i.index)!=null?r:0)+i[0].length,target:i[1]})}function $a(o,e){var t,r;for(let i of o.matchAll(La))e.push({type:"chain",start:(t=i.index)!=null?t:0,end:((r=i.index)!=null?r:0)+i[0].length,target:i[1]})}function qa(o){let e=[],t={triple:5,chain:4,continuation:3,prefix:2,suffix:1},r=[...o].sort((i,n)=>i.start!==n.start?i.start-n.start:t[n.type]-t[i.type]);for(let i of r)e.some(s=>i.start>=s.start&&i.start<s.end||i.end>s.start&&i.end<=s.end||i.start<=s.start&&i.end>=s.end)||e.push(i);return e.sort((i,n)=>i.start-n.start)}function yn(o,e){if(!o)return[];let t=[],r=_a(e),i=vn(o);for(let[n,s]of r.entries())for(let a of s){let l=Ga(a,o,i);l!==void 0&&t.push(...Fa(n,l))}return oo(t)}function Ga(o,e,t){var i,n;if(o.startsWith('"')&&o.endsWith('"')){let s=o.slice(1,-1).toLowerCase();return t.get(s)}let r=o.indexOf(".");if(r!==-1){let s=o.slice(0,r).toLowerCase(),a=o.slice(r+1).toLowerCase(),l=(n=e[s])!=null?n:e[(i=Object.keys(e).find(c=>c.toLowerCase()===s))!=null?i:""];if(l&&typeof l=="object"&&!Array.isArray(l)){let c=l,m=Object.keys(c).find(d=>d.toLowerCase()===a);if(m)return c[m]}return}return t.get(o)}function xn(o,e){if(!o)return{};let t={},r=vn(o),i=new Set([...e,"relations"]);for(let[n,s]of r.entries())if(!i.has(n)&&s!==void 0){if(s===null){t[n]=null;continue}if(typeof s=="string"||typeof s=="number"||typeof s=="boolean"){t[n]=s;continue}if(Array.isArray(s)){let a=s.filter(l=>typeof l=="string");a.length>0&&(t[n]=a)}}return t}function Fa(o,e){let t=ro(o);return Mr(t)?Wa(e).map(i=>gn(i)).filter(i=>i.length>0).map(i=>({relation:t,target:i})):[]}function Wa(o){return Array.isArray(o)?o.filter(e=>typeof e=="string"):typeof o=="string"?[o]:[]}function _a(o){let e=new Map;for(let t of o){if(!Mr(t.id))continue;let r=t.aliases.map(i=>i.key.toLowerCase());e.set(t.id,r)}return e}function vn(o){let e=new Map;for(let[t,r]of Object.entries(o))e.set(t.toLowerCase(),r);return e}function Nn(o,e,t){var a,l;let r=new Map;for(let c of e){let m=(a=r.get(c.toPath))!=null?a:[];m.push(c),r.set(c.toPath,m)}let i=new Set,n=[{path:o,depth:0}],s=[];for(i.add(o);n.length>0;){let c=n.shift();if(!c)break;let m=(l=r.get(c.path))!=null?l:[];for(let d of m)t&&t.size>0&&!t.has(d.relation)||i.has(d.fromPath)||(i.add(d.fromPath),s.push({path:d.fromPath,depth:c.depth+1,viaRelation:d.relation,implied:d.implied,impliedFrom:d.impliedFrom}),n.push({path:d.fromPath,depth:c.depth+1}))}return s}function Cn(o,e){var n;if(e.length===0)return o;let t=[],r=new Set(o.map(s=>wn(s))),i=ja(e);for(let s of o){let a=(n=i.get(s.relation))!=null?n:[];for(let l of a){let c=l.baseRelation.trim().toLowerCase(),m=l.impliedRelation.trim().toLowerCase();if(!(!c||!m)){if(l.direction==="forward"||l.direction==="both"){let d={fromPath:s.fromPath,toPath:s.toPath,relation:m,implied:!0,impliedFrom:s.relation};yr(d,t,r)}if(l.direction==="reverse"||l.direction==="both"){let d={fromPath:s.toPath,toPath:s.fromPath,relation:m,implied:!0,impliedFrom:s.relation};yr(d,t,r)}}}}return za(o,i,t,r),[...o,...t]}function za(o,e,t,r){var s,a,l,c,m;let i=new Map,n=new Map;for(let d of o){if(!((s=e.get(d.relation))!=null?s:[]).some(k=>k.direction==="sibling"))continue;let y=i.get(d.toPath);y||(y=new Map,i.set(d.toPath,y));let N=(a=y.get(d.relation))!=null?a:[];N.push(d),y.set(d.relation,N);let C=n.get(d.fromPath);C||(C=new Map,n.set(d.fromPath,C));let R=(l=C.get(d.relation))!=null?l:[];R.push(d),C.set(d.relation,R)}for(let d of i.values())for(let[f,g]of d){if(g.length<2)continue;let N=((c=e.get(f))!=null?c:[]).filter(C=>C.direction==="sibling");for(let C of N){let R=C.impliedRelation.trim().toLowerCase();if(R)for(let k=0;k<g.length;k++){let q=g[k];for(let D=k+1;D<g.length;D++){let L=g[D];yr({fromPath:q.fromPath,toPath:L.fromPath,relation:R,implied:!0,impliedFrom:f},t,r),yr({fromPath:L.fromPath,toPath:q.fromPath,relation:R,implied:!0,impliedFrom:f},t,r)}}}}for(let d of n.values())for(let[f,g]of d){if(g.length<2)continue;let N=((m=e.get(f))!=null?m:[]).filter(C=>C.direction==="sibling");for(let C of N){let R=C.impliedRelation.trim().toLowerCase();if(R)for(let k=0;k<g.length;k++){let q=g[k];for(let D=k+1;D<g.length;D++){let L=g[D];yr({fromPath:q.toPath,toPath:L.toPath,relation:R,implied:!0,impliedFrom:f},t,r),yr({fromPath:L.toPath,toPath:q.toPath,relation:R,implied:!0,impliedFrom:f},t,r)}}}}}function ja(o){var t;let e=new Map;for(let r of o)if(r.id)for(let i of r.impliedRelations){let n=i.targetRelation.trim().toLowerCase();if(!n)continue;let s=(t=e.get(r.id))!=null?t:[];s.push({baseRelation:r.id,impliedRelation:n,direction:i.direction}),e.set(r.id,s)}return e}function yr(o,e,t){let r=wn(o);t.has(r)||(t.add(r),e.push(o))}function wn(o){return`${o.fromPath}|${o.toPath}|${o.relation}`}function bn(o){let e=new Set;for(let t of o)for(let r of t.aliases){let i=r.key;if(i.startsWith('"')&&i.endsWith('"')){e.add(i.slice(1,-1).toLowerCase());continue}i.includes(".")||e.add(i.toLowerCase())}return e}var no=class{constructor(e,t){this.app=e,this.settings=t,this.edgesBySource=new Map,this.edgesByTarget=new Map,this.propertiesByPath=new Map,this.staleFiles=new Set,this.allStale=!0,this.changeListeners=new Set,this.cachedEdgesWithImplied=null}onDidChange(e){return this.changeListeners.add(e),()=>{this.changeListeners.delete(e)}}updateSettings(e){this.settings=e,this.invalidateImpliedCache(),this.rebuildTargetIndex()}async build(){this.edgesBySource.clear(),this.edgesByTarget.clear(),this.propertiesByPath.clear(),this.cachedEdgesWithImplied=null;let e=this.app.vault.getMarkdownFiles();for(let t of e)await this.updateFile(t,!1);this.rebuildTargetIndex(),this.staleFiles.clear(),this.allStale=!1,this.emitChange()}async updateFile(e,t=!0){let{edges:r,properties:i}=await this.parseFileData(e);this.edgesBySource.set(e.path,r),this.propertiesByPath.set(e.path,i),this.invalidateImpliedCache(),t&&(this.rebuildTargetIndex(),this.emitChange())}markFileStale(e){this.staleFiles.add(e)}markAllStale(){this.allStale=!0,this.staleFiles.clear()}async ensureFresh(){if(this.allStale){await this.build();return}if(this.staleFiles.size===0)return;let e=Array.from(this.staleFiles);this.staleFiles.clear();for(let t of e){let r=this.app.vault.getAbstractFileByPath(t);r instanceof io.TFile?await this.updateFile(r,!1):(this.edgesBySource.delete(t),this.propertiesByPath.delete(t),this.invalidateImpliedCache())}this.rebuildTargetIndex(),this.emitChange()}handleRename(e,t){let r=this.edgesBySource.get(e);if(r){let n=r.map(s=>({...s,fromPath:t}));this.edgesBySource.set(t,n),this.edgesBySource.delete(e)}let i=this.propertiesByPath.get(e);i&&(this.propertiesByPath.set(t,i),this.propertiesByPath.delete(e));for(let[n,s]of this.edgesBySource.entries()){let a=!1,l=s.map(c=>c.toPath===e?(a=!0,{...c,toPath:t}):c);a&&this.edgesBySource.set(n,l)}this.staleFiles.has(e)&&(this.staleFiles.delete(e),this.staleFiles.add(t)),this.invalidateImpliedCache(),this.rebuildTargetIndex(),this.emitChange()}handleDelete(e){this.edgesBySource.delete(e),this.propertiesByPath.delete(e);for(let[t,r]of this.edgesBySource.entries()){let i=r.filter(n=>n.toPath!==e);i.length!==r.length&&this.edgesBySource.set(t,i)}this.staleFiles.delete(e),this.invalidateImpliedCache(),this.rebuildTargetIndex(),this.emitChange()}emitChange(){for(let e of this.changeListeners)e()}getRelationTypes(){let e=[],t=new Set;for(let r of this.settings.relations)r.id&&!t.has(r.id)&&(e.push(r.id),t.add(r.id));for(let r of this.getEdgesWithImplied())t.has(r.relation)||(e.push(r.relation),t.add(r.relation));return e}getIncomingEdges(e,t){var i;let r=(i=this.edgesByTarget.get(e))!=null?i:[];return!t||t.size===0?r:r.filter(n=>t.has(n.relation))}getOutgoingEdges(e,t){return this.getEdgesWithImplied().filter(r=>r.fromPath!==e?!1:!t||t.size===0?!0:t.has(r.relation))}getAncestors(e,t){return Nn(e,this.getEdgesWithImplied(),t)}invalidateImpliedCache(){this.cachedEdgesWithImplied=null}rebuildTargetIndex(){var t;this.edgesByTarget.clear();let e=this.getEdgesWithImplied();for(let r of e){let i=(t=this.edgesByTarget.get(r.toPath))!=null?t:[];i.push(r),this.edgesByTarget.set(r.toPath,i)}}getEdgesWithImplied(){if(this.cachedEdgesWithImplied!==null)return this.cachedEdgesWithImplied;let e=Array.from(this.edgesBySource.values()).flat();return this.cachedEdgesWithImplied=Cn(e,this.settings.relations),this.cachedEdgesWithImplied}getEdgesByTarget(){return this.edgesByTarget}async parseFileData(e){let t=await this.app.vault.read(e),r=new Set(this.settings.relations.map(d=>d.id).filter(d=>d.length>0)),i=hn(t,r),n=this.app.metadataCache.getFileCache(e),s=yn(n==null?void 0:n.frontmatter,this.settings.relations),a=bn(this.settings.relations),l=xn(n==null?void 0:n.frontmatter,a),c=[...i,...s],m=[];for(let d of c){let f,g;if(d.source){let y=this.app.metadataCache.getFirstLinkpathDest(d.source,e.path);if(!y||!(y instanceof io.TFile))continue;f=y.path}else f=e.path;if(d.target){let y=this.app.metadataCache.getFirstLinkpathDest(d.target,e.path);if(!y||!(y instanceof io.TFile))continue;g=y.path}else g=e.path;m.push({fromPath:f,toPath:g,relation:d.relation,implied:!1})}return{edges:m,properties:l}}getFileProperties(e){var t;return(t=this.propertiesByPath.get(e))!=null?t:{}}};var Re=require("obsidian");function so(o){if(o.length===0)return[];let e=[],t=new Set;for(let r=0;r<o.length;r++){if(t.has(r))continue;let i=o[r];if(!i)continue;let n=[i];t.add(r);for(let s=r+1;s<o.length;s++){if(t.has(s))continue;let a=o[s];a&&a.relation===i.relation&&En(i.children,a.children)&&(n.push(a),t.add(s))}e.push(Ua(n))}return e}function Ua(o){let e=o[0];if(!e)return{relation:"",members:[],subgroups:[]};let t=e.relation,r=o.map(n=>({path:n.path,relation:n.relation,implied:n.implied,impliedFrom:n.impliedFrom,properties:n.properties,displayProperties:n.displayProperties.map(s=>({key:s.key,value:s.value}))})),i=so(e.children);return{relation:t,members:r,subgroups:i}}function En(o,e){if(o.length!==e.length)return!1;if(o.length===0)return!0;let t=[...o].sort((i,n)=>i.path.localeCompare(n.path)),r=[...e].sort((i,n)=>i.path.localeCompare(n.path));for(let i=0;i<t.length;i++){let n=t[i],s=r[i];if(!n||!s||n.path!==s.path||!En(n.children,s.children))return!1}return!0}function Sn(o){let e=[];for(let t of o)e.push(...On(t,null));return e}function On(o,e){let t={...o,subgroups:e?[e]:[]};if(o.subgroups.length===0)return[t];let r=[];for(let i of o.subgroups)r.push(...On(i,t));return r}function Yo(o){let e=[];for(let t of o)e.push({...t,children:[]}),t.children.length>0&&e.push(...Yo(t.children));return e}var xr=require("obsidian");function Rn(o,e,t,r){let i=o.createDiv({cls:"trail-empty-state"}),n=i.createDiv({cls:"trail-empty-icon"});return(0,xr.setIcon)(n,e),i.createDiv({cls:"trail-empty-title",text:t}),i.createDiv({cls:"trail-empty-description",text:r}),i}function Dn(o,e,t){let r=e.vault.getAbstractFileByPath(t),i=r instanceof xr.TFile?r.basename:t,n=o.createEl("a",{text:i,cls:"internal-link",attr:{"data-path":t}});return n.addEventListener("click",s=>{s.preventDefault(),e.workspace.openLinkText(t,"",!1)}),n}function Ko(o,e,t,r){let i=o.createDiv({cls:"tree-item trail-section"}),n=i.createDiv({cls:"tree-item-self trail-section-header is-clickable"}),s=n.createDiv({cls:"tree-item-icon collapse-icon"});(0,xr.setIcon)(s,"chevron-down");let a=n.createSpan({cls:"trail-section-icon"});(0,xr.setIcon)(a,t),n.createSpan({cls:"tree-item-inner trail-section-title"}).setText(e),r!==void 0&&r>0&&n.createSpan({cls:"tree-item-flair"}).createSpan({cls:"tree-item-flair-text",text:String(r)});let c=i.createDiv({cls:"tree-item-children trail-section-content"}),m=!1;return n.addEventListener("click",()=>{m=!m,i.toggleClass("is-collapsed",m),s.toggleClass("is-collapsed",m)}),{sectionEl:i,headerEl:n,contentEl:c}}var Ut="trail-view",Ir=class extends Re.ItemView{constructor(e,t){super(e),this.plugin=t,this.selectedRelations=new Set}getViewType(){return Ut}getDisplayText(){return"Trail"}getIcon(){return"git-branch"}async onOpen(){this.addAction("filter","Filter relations",()=>{this.showFilterMenu()}),this.addAction("refresh-cw","Refresh",()=>{this.refresh()}),this.refresh()}showFilterMenu(){let e=new Re.Menu,t=this.plugin.graph.getRelationTypes();t.length===0?e.addItem(r=>{r.setTitle("No relations defined"),r.setDisabled(!0)}):this.addFilterMenuItems(e,t),this.showMenuAtActionButtons(e)}addFilterMenuItems(e,t){e.addItem(r=>{r.setTitle("Select all"),r.setIcon("check-square"),r.onClick(()=>{for(let i of t)this.selectedRelations.add(i);this.refresh()})}),e.addItem(r=>{r.setTitle("Select none"),r.setIcon("square"),r.onClick(()=>{this.selectedRelations.clear(),this.refresh()})}),e.addSeparator();for(let r of t)e.addItem(i=>{let n=this.selectedRelations.has(r);i.setTitle(r),i.setIcon(n?"check":""),i.onClick(()=>{n?this.selectedRelations.delete(r):this.selectedRelations.add(r),this.refresh()})})}showMenuAtActionButtons(e){let t=this.containerEl.querySelector(".view-actions");if(t){let r=t.getBoundingClientRect();e.showAtPosition({x:r.right,y:r.bottom})}else e.showAtMouseEvent(new MouseEvent("click"))}async refresh(){await this.plugin.graph.ensureFresh();let{contentEl:e}=this;e.empty(),e.addClass("trail-view");let t=this.plugin.app.workspace.getActiveFile();if(!t){Rn(e,"file-question","No active note","Open a note to see its relations");return}this.initializeSelectedRelations(),this.renderHeader(e,t),this.renderGroups(e.createDiv({cls:"trail-content"}),t)}initializeSelectedRelations(){let e=this.plugin.graph.getRelationTypes();if(this.selectedRelations.size===0)for(let t of e)this.selectedRelations.add(t)}renderHeader(e,t){let r=e.createDiv({cls:"trail-context"}),i=r.createSpan({cls:"trail-context-icon"});(0,Re.setIcon)(i,"file-text"),r.createSpan({cls:"trail-context-text",text:t.basename});let n=this.plugin.graph.getRelationTypes();if(this.selectedRelations.size<n.length&&n.length>0){let s=r.createSpan({cls:"trail-filter-badge"});s.setText(`${this.selectedRelations.size}/${n.length}`),s.setAttribute("aria-label","Active relation filters")}}renderGroups(e,t){let r=this.plugin.settings.tqlGroups;if(r.length===0){e.createDiv({cls:"trail-no-results",text:"No groups configured"});return}let i=0;for(let n of r){if(n.enabled===!1)continue;this.renderTqlGroup(e,n,t.path)&&i++}i===0&&e.createDiv({cls:"trail-no-results",text:"No groups match this note"})}renderTqlGroup(e,t,r){var i;try{let n=this.executeTqlQuery(t.query,r);if(!n.visible)return!1;let s=n.results.length===0;if(s&&this.plugin.settings.hideEmptyGroups)return!1;let a=t.name;if(!a)try{a=V(t.query).group}catch(m){a="TQL Group"}let l=Ko(e,a,"layers",n.results.length);if(s)return l.contentEl.createDiv({cls:"trail-no-results",text:"No relations found"}),!0;let c=this.transformTqlToDisplayGroups(n.results);return this.renderDisplayGroups(l.contentEl,c,0),!0}catch(n){let s=Ko(e,(i=t.name)!=null?i:"TQL Group","alert-triangle",0),a=n instanceof pt?n.message:String(n);return s.contentEl.createDiv({cls:"trail-error",text:`Query error: ${a}`}),!0}}executeTqlQuery(e,t){let r=_t(),i=r.getResult(e,t);if(i)return i;let n=V(e),s=this.plugin.settings.relations.map(d=>d.id),a=this.plugin.settings.tqlGroups.map(d=>{try{return V(d.query).group}catch(f){return null}}).filter(d=>d!==null),l=Rt(s,a);n.validate(l);let c=this.createQueryContext(t),m=Jr(n,c);return r.setResult(e,t,m),m}createQueryContext(e){var n,s;let t=this.plugin.graph,r=this.plugin.settings,i=(s=(n=t.getFileProperties)==null?void 0:n.call(t,e))!=null?s:{};return{activeFilePath:e,activeFileProperties:i,getOutgoingEdges:(a,l)=>{let c=l?new Set([l]):void 0;return t.getOutgoingEdges(a,c)},getIncomingEdges:(a,l)=>{let c=l?new Set([l]):void 0;return t.getIncomingEdges(a,c)},getProperties:a=>{var l,c;return(c=(l=t.getFileProperties)==null?void 0:l.call(t,a))!=null?c:{}},getFileMetadata:a=>{var y,N,C,R,k,q;let l=this.plugin.app.vault.getAbstractFileByPath(a);if(!(l instanceof Re.TFile))return;let c=this.plugin.app.metadataCache,m=c.getFileCache(l),d=(N=(y=m==null?void 0:m.links)==null?void 0:y.map(D=>D.link))!=null?N:[],f=[],g=c.resolvedLinks;for(let D in g){let L=g[D];L&&a in L&&f.push(D)}return{name:l.basename,path:l.path,folder:(R=(C=l.parent)==null?void 0:C.path)!=null?R:"",created:new Date(l.stat.ctime),modified:new Date(l.stat.mtime),size:l.stat.size,tags:(q=(k=m==null?void 0:m.tags)==null?void 0:k.map(D=>D.tag))!=null?q:[],links:d,backlinks:f}},getRelationNames:()=>r.relations.map(a=>a.id),getVisualDirection:a=>{var c;let l=r.relations.find(m=>m.id===a);return(c=l==null?void 0:l.visualDirection)!=null?c:"descending"},getSequentialRelations:()=>new Set(r.relations.filter(a=>a.visualDirection==="sequential").map(a=>a.id)),resolveGroupQuery:a=>{let l=r.tqlGroups.find(c=>{try{return V(c.query).group===a}catch(m){return!1}});if(l)try{let c=V(l.query),m=r.relations.map(f=>f.id),d=r.tqlGroups.map(f=>{try{return V(f.query).group}catch(g){return null}}).filter(f=>f!==null);return c.validate(Rt(m,d)),c}catch(c){return}}}}transformTqlToDisplayGroups(e){var i,n;if(e.length===0)return[];let t=(n=(i=e[0])==null?void 0:i.visualDirection)!=null?n:"descending";if(t==="sequential"){let s=Yo(e);return so(s)}let r=so(e);return t==="ascending"?Sn(r):r}renderDisplayGroups(e,t,r){for(let i of t)this.renderDisplayGroup(e,i,r)}renderDisplayGroup(e,t,r){let i=e.createDiv({cls:"trail-group"});if(i.style.setProperty("--group-depth",String(r)),t.members.length>0){let n=i.createDiv({cls:"trail-group-members"}),s=t.members[0];s&&this.renderRelationTag(n,s.relation,s.implied),t.label&&n.createSpan({cls:"trail-group-label",text:t.label});for(let a of t.members)this.renderGroupMember(n,a)}if(t.subgroups.length>0){let n=i.createDiv({cls:"trail-group-subgroups"});this.renderDisplayGroups(n,t.subgroups,r+1)}}renderGroupMember(e,t){let r=e.createDiv({cls:"trail-group-member"});Dn(r,this.plugin.app,t.path),this.renderPropertyBadges(r,t.displayProperties)}renderPropertyBadges(e,t){if(t.length===0)return;let r=[];for(let{key:n,value:s}of t)s!=null&&r.push(this.formatPropertyValue(n,s));if(r.length===0)return;let i=e.createDiv({cls:"trail-property-badges"});for(let n of r)i.createSpan({cls:"trail-property-badge",text:n})}formatPropertyValue(e,t){return Array.isArray(t)?t.length===0?"":`${e}: ${t.join(", ")}`:t===null?`${e}: null`:typeof t=="object"?`${e}: [object]`:`${e}: ${t}`}getRelationDefinition(e){return this.plugin.settings.relations.find(t=>t.id===e)}renderRelationTag(e,t,r){let i=e.createSpan({cls:"trail-relation-tag"}),n=this.getRelationDefinition(t),s=n?De(n):t;n!=null&&n.icon?((0,Re.setIcon)(i,n.icon),i.setAttribute("aria-label",s),i.addClass("has-icon")):i.setText(s),r&&i.addClass("is-implied")}};function Tn(o){o.addCommand({id:"open-pane",name:"Open pane",callback:async()=>{await Ha(o)}}),o.addCommand({id:"refresh-graph",name:"Refresh graph",callback:async()=>{await o.graph.build(),o.refreshActiveView()}})}async function Ha(o){let t=o.app.workspace.getLeavesOfType(Ut)[0];if(t){o.app.workspace.revealLeaf(t);return}let r=o.app.workspace.getRightLeaf(!1);r&&await r.setViewState({type:Ut,active:!0})}var ao=class extends Xr.Plugin{async onload(){await this.loadSettings(),this.graph=new no(this.app,this.settings),this.changedFiles=new Set,this.refreshTimeoutId=null,this.graphRefreshTimeoutId=null,this.registerView(Ut,t=>new Ir(t,this)),this.addSettingTab(new Lr(this.app,this)),Tn(this);let e=this.graph.onDidChange(()=>{this.queueGraphRefresh()});this.register(()=>e()),this.registerEvent(this.app.metadataCache.on("changed",t=>{t&&this.queueFileChange(t)})),this.registerEvent(this.app.vault.on("rename",(t,r)=>{if(t instanceof Xr.TFile){this.graph.handleRename(r,t.path);let i=_t();i.invalidateFile(r),i.invalidateFile(t.path)}})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof Xr.TFile&&(this.graph.handleDelete(t.path),_t().invalidateFile(t.path))})),this.registerEvent(this.app.workspace.on("file-open",()=>{this.refreshActiveView()})),this.registerEvent(this.app.metadataCache.on("resolved",()=>{this.onMetadataCacheReady()})),this.app.workspace.onLayoutReady(()=>{this.onMetadataCacheReady()})}async onMetadataCacheReady(){await this.graph.build(),this.refreshActiveView()}onunload(){}refreshActiveView(){let e=this.app.workspace.getLeavesOfType(Ut);for(let t of e){let r=t.view;r instanceof Ir&&r.refresh()}}async loadSettings(){let e=await this.loadData(),t=mn(e);this.settings=dn(e),t&&await this.saveData(this.settings)}async saveSettings(){await this.saveData(this.settings),this.graph.updateSettings(this.settings),this.graph.markAllStale(),this.refreshActiveView()}queueFileChange(e){this.changedFiles.add(e.path),this.refreshTimeoutId!==null&&window.clearTimeout(this.refreshTimeoutId),this.refreshTimeoutId=window.setTimeout(()=>{this.flushFileChanges()},300)}flushFileChanges(){let e=_t();for(let r of this.changedFiles)this.graph.markFileStale(r),e.invalidateFile(r);let t=this.app.workspace.getActiveFile();t&&e.invalidateFile(t.path),this.changedFiles.clear(),this.refreshActiveView()}queueGraphRefresh(){this.graphRefreshTimeoutId!==null&&window.clearTimeout(this.graphRefreshTimeoutId),this.graphRefreshTimeoutId=window.setTimeout(()=>{this.graphRefreshTimeoutId=null,this.refreshActiveView()},150)}};
